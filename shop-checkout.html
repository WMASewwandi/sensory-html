<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/">

    <title>Checkout - Sensory - Kids Toys Store</title>

    <!--== Favicon ==-->
    <link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon" />

    <!--== Google Fonts ==-->
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One:400" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!--== Bootstrap CSS ==-->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet"/>
    <!--== Font-awesome Icons CSS ==-->
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet"/>
    <!--== Pe Icon 7 Min Icons CSS ==-->
    <link href="/assets/css/pe-icon-7-stroke.min.css" rel="stylesheet"/>
    <!--== Ionicons CSS ==-->
    <link href="/assets/css/ionicons.css" rel="stylesheet"/>
    <!--== Animate CSS ==-->
    <link href="/assets/css/animate.css" rel="stylesheet"/>
    <!--== Aos CSS ==-->
    <link href="/assets/css/aos.css" rel="stylesheet"/>
    <!--== FancyBox CSS ==-->
    <link href="/assets/css/jquery.fancybox.min.css" rel="stylesheet"/>
    <!--== Slicknav CSS ==-->
    <link href="/assets/css/slicknav.css" rel="stylesheet"/>
    <!--== Swiper CSS ==-->
    <link href="/assets/css/swiper.min.css" rel="stylesheet"/>
    <!--== Slick CSS ==-->
    <link href="/assets/css/slick.css" rel="stylesheet"/>
    <!--== Rangeslider CSS ==-->
    <link href="/assets/css/rangeslider.css" rel="stylesheet"/>
    <!--== Main Style CSS ==-->
    <link href="/assets/css/style.css" rel="stylesheet" />

</head>

<body>

<!--wrapper start-->
<div class="wrapper page-shop-wrapper">

  <!--== Start Preloader Content ==-->
  <div class="preloader-wrap">
    <div class="preloader">
      <span class="dot"></span>
      <div class="dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
  <!--== End Preloader Content ==-->

  <!--== Start Header Wrapper ==-->
  <header class="header-wrapper">
    <div class="header-top">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-sm-5 col-md-4 col-lg-6">
            <div class="header-info-left">
            </div>
          </div>
          <div class="col-xs-12 col-sm-7 col-md-8 col-lg-6 sm-pl-0 xs-pl-15 header-top-right">
            <div class="header-info">
              <a href="tel://+94761487787"><i class="fa fa-phone"></i> +94761487787</a>
              <a href="mailto:sensorysl12@gmail.com"><i class="fa fa-envelope"></i> sensorysl12@gmail.com</a>
              <a href="login-register"><i class="fa fa-user"></i> Account</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-middle">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-12">
            <div class="header-align">
              <div class="header-align-left">
                <div class="header-logo-area">
                  <a href="/">
                    <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                    <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
                  </a>
                </div>
              </div>
              <div class="header-align-center">
                <div class="header-search-box">
                  <form action="#" method="post">
                    <div class="form-input-item">
                      <label for="search" class="sr-only">Search Everything</label>
                      <input type="text" id="search" placeholder="Search Everything">
                      <button type="submit" class="btn-src">
                        <i class="pe-7s-search"></i>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
              <div class="header-align-right">
                <div class="header-action-area">
                  <div class="header-action-wishlist">
                    <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                      <span class="wishlist-count">0</span>
                      <i class="pe-7s-like"></i>
                    </button>
                  </div>
                  <div class="header-action-cart">
                    <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                      <span class="cart-count">0</span>
                      <i class="pe-7s-shopbag"></i>
                    </button>
                  </div>
                  <button class="btn-menu d-md-none">
                    <i class="ion-navicon"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-area header-default sticky-header">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-4 col-sm-6 col-lg-2">
            <div class="header-logo-area">
              <a href="/">
                <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
              </a>
            </div>
          </div>
          <div class="col-lg-8 sticky-md-none">
            <div class="header-navigation-area d-none d-md-block">
              <ul class="main-menu nav position-relative" id="main-nav-menu">
                <li><a class="ml--2" href="/">Home</a></li>
                <!-- Main category links are injected by JS (up to 5 categories) -->
              </ul>
            </div>
          </div>
          <div class="col-8 col-sm-6 col-lg-2">
            <div class="header-action-area">
              <div class="header-action-search">
                <button class="btn-search btn-search-menu">
                  <i class="pe-7s-search"></i>
                </button>
              </div>
              <div class="header-action-login">
                <button class="btn-login" onclick="window.location.href='login-register'">
                  <i class="pe-7s-users"></i>
                </button>
              </div>
              <div class="header-action-wishlist">
                <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                  <i class="pe-7s-like"></i>
                </button>
              </div>
              <div class="header-action-cart">
                <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                  <span class="cart-count">0</span>
                  <i class="pe-7s-shopbag"></i>
                </button>
              </div>
              <button class="btn-menu d-lg-none">
                <i class="ion-navicon"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <!--== End Header Wrapper ==-->
  
  <main class="main-content">
    <!--== Start Page Title Area ==-->
    <section class="page-title-area">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-12 m-auto">
            <div class="page-title-content text-center">
              <h2 class="title">Checkout</h2>
              <!-- <div class="bread-crumbs"><a href="/"> Home </a><span class="breadcrumb-sep"> // </span><span class="active"> Checkout</span></div> -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--== End Page Title Area ==-->

    <!--== Start Checkout Area Wrapper ==-->
    <section class="product-area shop-checkout-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 m-auto">
            <div class="section-title text-center">
              <h2 class="title">Checkout</h2>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
          </div>
        </div>
        <div class="row">
          <div class="col-lg-7">
            <div class="billing-info-wrap">
              <h3>Billing Details</h3>
              <div class="row">
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>First name <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Last name <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Street Address <abbr class="required" title="required">*</abbr></label>
                    <input class="billing-address" placeholder="House number and street name" type="text">
                    <input placeholder="Apartment, suite, unit, etc. (optional)" type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Town / City <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>District <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Postcode / ZIP (optional) <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Phone <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
                <div class="col-12">
                  <div class="billing-info mb-20">
                    <label>Email Address <abbr class="required" title="required">*</abbr></label>
                    <input type="text">
                  </div>
                </div>
              </div>
              <div class="additional-info-wrap">
                <label>Order notes (optional)</label>
                <textarea placeholder="Notes about your order, e.g. special notes for delivery. " name="message"></textarea>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="your-order-area">
              <h3>Your order</h3>
              <div class="your-order-wrap">
                <div class="your-order-info-wrap">
                  <div class="your-order-title">
                    <h4>Product <span>Subtotal</span></h4>
                  </div>
                  <div class="your-order-product">
                    <ul>
                      <!-- Order items will be loaded dynamically here -->
                    </ul>
                  </div>
                  <div class="your-order-subtotal">
                    <h3>Subtotal <span id="checkout-subtotal">LKR 0.00</span></h3>
                  </div>
                  <div class="your-order-shipping">
                    <h3>Shipping <span id="checkout-shipping">LKR 450.00</span></h3>
                    <p class="shipping-note" style="font-size: 12px; color: #666; margin-top: 8px; margin-bottom: 0;">Free shipping for orders over LKR 40,000</p>
                  </div>
                  <div class="your-order-total">
                    <h3>Total <span id="checkout-total">LKR 0.00</span></h3>
                  </div>
                </div>
                <div class="payment-method">
                  <div class="pay-top sin-payment">
                    <input id="payment_method_1" class="input-radio" type="radio" value="directpay" checked="checked" name="payment_method">
                    <label for="payment_method_1"> Pay with Card (DirectPay) </label>
                    <div class="payment-box payment_method_directpay">
                      <p>Pay securely using your Visa or Mastercard. Your payment is processed through DirectPay payment gateway.</p>
                      <div class="payment-cards-icons" style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="24" viewBox="0 0 750 471"><g fill="none" fill-rule="evenodd"><rect width="750" height="471" fill="#0E4595" rx="40"/><path fill="#FFF" d="M278.198 334.228l33.36-195.763h53.358l-33.384 195.763zM524.307 142.687c-10.57-3.966-27.135-8.222-47.822-8.222-52.725 0-89.863 26.551-90.18 64.604-.297 28.129 26.514 43.821 46.754 53.185 20.771 9.598 27.752 15.716 27.652 24.283-.133 13.123-16.586 19.116-31.924 19.116-21.355 0-32.701-2.967-50.225-10.274l-6.879-3.112-7.488 43.823c12.463 5.467 35.508 10.199 59.438 10.445 56.09 0 92.502-26.248 92.916-66.885.199-22.27-14.016-39.215-44.801-53.188-18.65-9.056-30.072-15.099-29.951-24.269 0-8.137 9.668-16.838 30.559-16.838 17.447-.271 30.088 3.534 39.936 7.5l4.781 2.259 7.234-42.427M661.615 138.464h-41.23c-12.773 0-22.332 3.486-27.941 16.234l-79.244 179.53h56.031s9.16-24.121 11.232-29.418c6.123 0 60.555.084 68.336.084 1.596 6.854 6.492 29.334 6.492 29.334h49.512l-43.188-195.764zm-65.417 126.408c4.414-11.279 21.26-54.724 21.26-54.724-.314.521 4.381-11.334 7.074-18.684l3.607 16.878s10.217 46.729 12.352 56.53h-44.293zM232.903 138.464l-52.24 133.496-5.565-27.129c-9.726-31.274-40.025-65.157-73.898-82.12l47.767 171.204 56.455-.063 84.004-195.388h-56.523"/><path fill="#F2AE14" d="M131.92 138.464H45.879l-.682 4.073c66.939 16.204 111.232 55.363 129.618 102.415l-18.71-89.96c-3.229-12.396-12.597-16.095-24.186-16.528"/></g></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="24" viewBox="0 0 750 471"><g fill="none" fill-rule="evenodd"><rect width="750" height="471" fill="#FFF" rx="40"/><circle cx="250" cy="235" r="150" fill="#EB001B"/><circle cx="500" cy="235" r="150" fill="#F79E1B"/><path fill="#FF5F00" d="M325 235c0-54.3 28.8-101.8 72-128.1-32.1-21.2-70.6-33.6-112-33.6-112.4 0-203.5 89.5-203.5 200s91.1 200 203.5 200c41.4 0 79.9-12.4 112-33.6-43.2-26.3-72-73.8-72-128.1z"/></g></svg>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Card Payment Container -->
                <div id="directpay_container" class="directpay-container" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
                  <div id="card_container">
                    <!-- Manual Card Entry Form -->
                    <div class="manual-card-form" style="padding: 10px;">
                      <h5 style="margin-bottom: 20px; color: #333; font-size: 16px;">
                        <i class="fa fa-credit-card"></i> Enter Card Details
                      </h5>
                      <div class="form-group" style="margin-bottom: 15px;">
                        <label for="card_number" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Card Number *</label>
                        <input type="text" id="card_number" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" 
                          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;"
                          oninput="formatCardNumber(this)">
                      </div>
                      <div style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1; margin-bottom: 15px;">
                          <label for="card_expiry" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Expiry Date *</label>
                          <input type="text" id="card_expiry" class="form-control" placeholder="MM/YY" maxlength="5"
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;"
                            oninput="formatExpiry(this)">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 15px;">
                          <label for="card_cvv" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">CVV *</label>
                          <input type="text" id="card_cvv" class="form-control" placeholder="123" maxlength="4"
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>
                      </div>
                      <div class="form-group" style="margin-bottom: 15px;">
                        <label for="card_name" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">Cardholder Name *</label>
                        <input type="text" id="card_name" class="form-control" placeholder="Name on card"
                          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                      </div>
                      <div style="display: flex; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 6px;">
                        <i class="fa fa-lock" style="color: #4CAF50; font-size: 20px;"></i>
                        <span style="font-size: 13px; color: #2e7d32;">Your payment information is secure and encrypted.</span>
                      </div>
                    </div>
                  </div>
                  <div id="directpay_sandbox_notice" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-top: 15px;">
                    <strong style="color: #856404;"><i class="fa fa-exclamation-triangle"></i> Test Mode</strong>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #856404;">
                      This is a test environment. Use any card details to simulate payment.<br>
                      <strong>Test Card:</strong> 4111 1111 1111 1111, Expiry: 12/25, CVV: 123
                    </p>
                  </div>
                </div>
                <div class="payment-condition">
                  <p>Your personal data will be used to process your order, support your experience throughout this website, and for other purposes described in our <a href="privacy-policy">privacy policy</a>.</p>
                </div>
              </div>
              <div class="place-order">
                <a href="#/">Place Order</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--== End Checkout Area Wrapper ==-->
  </main>

  <!--== Start Footer Area Wrapper ==-->
  <footer class="footer-area default-style" >
    <div class="footer-main">
      <div class="container">
        <div class="row">
          <div class="col-12 col-lg-4">
            <div class="widget-item item-style3">
              <div class="about-widget">
                <a class="footer-logo" href="/">
                  <img src="/assets/img/logo-light.png" alt="Logo">
                </a>
                <p>
                  Sensory a brand of ANKH Trading Pvt Ltd is a curated destination for premium sensory books, toddler sensory, and early learning products, created to support holistic childhood development. We bring together safe, reliable, and thoughtfully designed sensory essentials in one placeâ€”making it easier for parents, educators, and retailers to access quality products that encourage learning through play, exploration, and imagination.
0 
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-2">
            <div class="widget-item item-style1">
              <h4 class="widget-title">Quick Links</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-1">Quick Links</h4>
              <div id="dividerId-1" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap">
                  <ul class="nav-menu nav item-hover-style">
                    <li><a href="/">- Home</a></li>
                    <li><a href="about">- About</a></li>
                    <li><a href="shop">- Shop</a></li>
                    <li><a href="contact">- Contact</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="widget-item item-style2">
              <h4 class="widget-title">Company</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-3">Company</h4>
              <div id="dividerId-3" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap item-hover-style">
                  <ul class="nav-menu nav">
                    <li><a href="terms-and-conditions">- Terms & Conditions</a></li>
                    <li><a href="privacy-policy">- Privacy Policy</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="widget-item">
              <h4 class="widget-title">Store Information.</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-4">Store Information.</h4>
              <div id="dividerId-4" class="collapse widget-collapse-body">
                <p class="widget-address">296/A/1 , Level 2 <br>New Kandy Road, <br>Kothalawala, <br>Kaduwela,
                    <br>Sri Lanka</p>
                  <ul class="widget-contact-info">
                    <li>Phone: <a href="tel://+94761487787">+94761487787</a></li>
                    <li>Email: <a href="mailto:sensorysl12@gmail.com">sensorysl12@gmail.com</a></li>
                  </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <div class="footer-bottom-content">
          <div class="row text-center">
            <div class="col-sm-12">
              <div class="widget-copyright">
                <p><i class="fa fa-copyright"></i> 2025 <span>Sensory. </span> All Rights Reserved</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-shape bg-img" data-bg-img="/assets/img/photos/footer1.png"></div>
  </footer>
  <!--== End Footer Area Wrapper ==-->
  
  <!--== Scroll Top Button ==-->
  <div class="scroll-to-top"><span class="fa fa-angle-double-up"></span></div>

  <!--== Start Product Quick View ==-->
  <aside class="product-quick-view-modal">
    <div class="product-quick-view-inner">
      <div class="product-quick-view-content">
        <button type="button" class="btn-close">
          <span class="pe-7s-close"><i class="lastudioicon-e-remove"></i></span>
        </button>
        <div class="row row-gutter-0">
          <div class="col-lg-6 col-md-6 col-12">
            <div class="thumb">
              <img src="/assets/img/shop/quick-view1.jpg" alt="Image">
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-12">
            <div class="single-product-info">
              <h4 class="title">Your Products Name Here.</h4>
              <div class="prices">
                <span class="price">LKR 0.00</span>
              </div>
              <div class="product-rating">
                <div class="rating">
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                </div>
                <div class="review">
                  <a href="#/">( 5 Customer Review )</a>
                </div>
              </div>
              <p class="product-desc">Lorem ipsum dolor sit amet, consect adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quisll exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duisol aute irure dolor in reprehenderit.</p>
              <div class="quick-product-action">
                <div class="action-top">
                  <div class="pro-qty">
                    <input type="text" id="quantity" title="Quantity" value="01" />
                  </div>
                  <button class="btn btn-theme">Add to Cart</button>
                  <a class="btn-wishlist" href="shop-wishlist">Add to Wishlist</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">SKU:</h3>
                <div class="widget-tags">
                  <span>Ch-256xl</span>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Categories:</h3>
                <div class="widget-tags">
                  <a href="blog">Toys.</a>
                  <a href="blog">Dresss</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Tag:</h3>
                <div class="widget-tags">
                  <a href="blog">Toys,</a>
                  <a href="blog">Dress</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Share:</h3>
                <div class="widget-tags widget-share">
                  <span class="fa fa-facebook"></span>
                  <span class="fa fa-dribbble"></span>
                  <span class="fa fa-pinterest-p"></span>
                  <span class="fa fa-twitter"></span>
                  <span class="fa fa-linkedin"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="canvas-overlay"></div>
  </aside>
  <!--== End Product Quick View ==-->

  <!--== Start Aside Search Menu ==-->
  <div class="search-box-wrapper">
    <div class="search-box-content-inner">
      <div class="search-box-form-wrap">
        <div class="search-note">
          <p>Start typing and press Enter to search</p>
        </div>
        <form action="#" method="post">
          <div class="search-form position-relative">
            <label for="search-input" class="sr-only">Search</label>
            <input type="search" class="form-control" placeholder="Search" id="search-input">
            <button class="search-button"><i class="pe-7s-search"></i></button>
          </div>
        </form>
      </div>
    </div>
    <!--== End Aside Search Menu ==-->
    <a href="javascript:;" class="search-close"><i class="pe-7s-close"></i></a>
  </div>
  <!--== End Aside Search Menu ==-->

  <!--== Start Sidebar Cart Menu ==-->
  <aside class="sidebar-cart-modal">
    <div class="sidebar-cart-inner">
      <div class="sidebar-cart-content">
        <a class="cart-close" href="javascript:void(0);"><i class="pe-7s-close"></i></a>
        <div class="sidebar-cart-all">
          <div class="cart-header">
            <h3>Shopping Cart</h3>
            <div class="close-style-wrap">
              <span class="close-style close-style-width-1 cart-close"></span>
            </div>
          </div>
          <div class="cart-content cart-content-padding">
            <ul id="sidebar-cart-items">
              <!-- Cart items will be loaded dynamically here -->
            </ul>
            <div class="cart-total">
              <h4>Subtotal: <span id="sidebar-cart-subtotal">LKR 0.00</span></h4>
            </div>
            <div class="cart-checkout-btn">
              <a class="cart-btn" href="shop-cart">view cart</a>
              <a class="checkout-btn" href="shop-checkout">checkout</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-cart-overlay"></div>
  <!--== End Sidebar Cart Menu ==-->

  <!--== Start Side Menu ==-->
  <aside class="off-canvas-wrapper">
    <div class="off-canvas-inner">
      <div class="off-canvas-overlay d-none"></div>
      <!-- Start Off Canvas Content Wrapper -->
      <div class="off-canvas-content">
        <!-- Off Canvas Header -->
        <div class="off-canvas-header">
          <div class="close-action">
            <button class="btn-close"><i class="pe-7s-close"></i></button>
          </div>
        </div>

        <div class="off-canvas-item">
          <!-- Start Mobile Menu Wrapper -->
          <div class="res-mobile-menu">
            <!-- Note Content Auto Generate By Jquery From Main Menu -->
          </div>
          <!-- End Mobile Menu Wrapper -->
        </div>
        <!-- Off Canvas Footer -->
        <div class="off-canvas-footer"></div>
      </div>
      <!-- End Off Canvas Content Wrapper -->
    </div>
  </aside>
  <!--== End Side Menu ==-->
</div>

<!--=======================Javascript============================-->

<!--=== Modernizr Min Js ===-->
<script src="/assets/js/modernizr.js"></script>
<!--=== jQuery Min Js ===-->
<script src="/assets/js/jquery-main.js"></script>
<!--=== jQuery Migration Min Js ===-->
<script src="/assets/js/jquery-migrate.js"></script>
<!--=== Popper Min Js ===-->
<script src="/assets/js/popper.min.js"></script>
<!--=== Bootstrap Min Js ===-->
<script src="/assets/js/bootstrap.min.js"></script>
<!--=== jquery Appear Js ===-->
<script src="/assets/js/jquery.appear.js"></script>
<!--=== jquery Swiper Min Js ===-->
<script src="/assets/js/swiper.min.js"></script>
<!--=== jquery Fancybox Min Js ===-->
<script src="/assets/js/fancybox.min.js"></script>
<!--=== jquery Aos Min Js ===-->
<script src="/assets/js/aos.min.js"></script>
<!--=== jquery Slicknav Js ===-->
<script src="/assets/js/jquery.slicknav.js"></script>
<!--=== jquery Countdown Js ===-->
<script src="/assets/js/jquery.countdown.min.js"></script>
<!--=== jquery Tippy Js ===-->
<script src="/assets/js/tippy.all.min.js"></script>
<!--=== Isotope Min Js ===-->
<script src="/assets/js/isotope.pkgd.min.js"></script>
<!--=== Parallax Min Js ===-->
<script src="/assets/js/parallax.min.js"></script>
<!--=== Slick  Min Js ===-->
<script src="/assets/js/slick.min.js"></script>
<!--=== jquery Wow Min Js ===-->
<script src="/assets/js/wow.min.js"></script>
<!--=== jquery Zoom Min Js ===-->
<script src="/assets/js/jquery-zoom.min.js"></script>

<!--=== API Config Js ===-->
<script src="/assets/js/config.js"></script>
<!--=== Cart & Wishlist Service Js ===-->
<script src="/assets/js/cart-service.js"></script>
<!--=== API Service Js ===-->
<script src="/assets/js/api-service.js"></script>
<!--=== DirectPay Payment Gateway ===-->
<script src="/assets/js/directpay-config.js"></script>
<script src="/assets/js/directpay-service.js"></script>
<!--=== Custom Js ===-->
<script src="/assets/js/custom.js"></script>

<!-- Checkout Page Integration -->
<style>
  /* DirectPay Container Styles */
  .directpay-container {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
  }
  
  .directpay-container #card_container {
    min-height: 300px;
    background: #fff;
    border: 1px solid #e8e8e8;
    border-radius: 6px;
    padding: 15px;
  }
  
  .directpay-container #card_container:empty::before {
    content: "Loading payment form...";
    display: block;
    text-align: center;
    padding: 40px;
    color: #888;
  }
  
  .directpay-container #card_container iframe {
    width: 100% !important;
    min-height: 350px;
    border: none !important;
  }
  
  /* DirectPay form elements */
  .directpay-container input,
  .directpay-container .dp-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  
  .payment-cards-icons img {
    height: 24px;
    margin-right: 8px;
    vertical-align: middle;
  }
  
  .sin-payment {
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 5px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }
  
  .sin-payment:hover {
    border-color: #ddd;
    background: #fafafa;
  }
  
  .sin-payment input[type="radio"] {
    margin-right: 10px;
  }
  
  .sin-payment label {
    font-weight: 500;
    cursor: pointer;
  }
  
  .payment-box {
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
    font-size: 13px;
    color: #666;
  }
  
  /* Spinner for loading state */
  .spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
  }
  
  .spinner-border.text-primary {
    color: #007bff !important;
  }
  
  @keyframes spinner-border {
    to {
      transform: rotate(360deg);
    }
  }

  /* Toast Notification Styles */
  .toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 16px 24px;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 99999;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 500px;
    animation: slideInRight 0.3s ease-out;
    font-size: 14px;
  }
  
  .toast-notification.success {
    background-color: #4CAF50;
  }
  
  .toast-notification.error {
    background-color: #f44336;
  }
  
  .toast-notification.warning {
    background-color: #ff9800;
  }
  
  .toast-notification.info {
    background-color: #2196F3;
  }
  
  .toast-notification .toast-icon {
    font-size: 20px;
  }
  
  .toast-notification .toast-message {
    flex: 1;
  }
  
  .toast-notification .toast-close {
    cursor: pointer;
    font-size: 18px;
    opacity: 0.8;
    transition: opacity 0.2s;
    line-height: 1;
  }
  
  .toast-notification .toast-close:hover {
    opacity: 1;
  }
  
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  .toast-notification.hide {
    animation: slideOutRight 0.3s ease-out forwards;
  }
</style>
<script>
// Card input formatting functions (global scope for inline handlers)
function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
  input.value = value.substring(0, 19);
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2, 4);
  }
  input.value = value;
}

function validateCardForm() {
  const cardNumber = $('#card_number').val().replace(/\s/g, '');
  const cardExpiry = $('#card_expiry').val();
  const cardCvv = $('#card_cvv').val();
  const cardName = $('#card_name').val().trim();
  
  if (!cardNumber || cardNumber.length < 13) {
    return { valid: false, message: 'Please enter a valid card number' };
  }
  if (!cardExpiry || cardExpiry.length < 5) {
    return { valid: false, message: 'Please enter a valid expiry date (MM/YY)' };
  }
  if (!cardCvv || cardCvv.length < 3) {
    return { valid: false, message: 'Please enter a valid CVV' };
  }
  if (!cardName) {
    return { valid: false, message: 'Please enter the cardholder name' };
  }
  
  return { valid: true };
}

function getStoredCustomerId() {
  try {
    const userData = sessionStorage.getItem('loggedInUser');
    if (userData) {
      const user = JSON.parse(userData);
      return user.id || user.customerId || null;
    }
    return null;
  } catch (e) {
    return null;
  }
}

// Save order to localStorage for display in My Account
function saveOrderToLocal(apiOrder, orderData) {
  try {
    const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
    if (!currentUser) return;
    
    const ordersKey = `user_orders_${currentUser.id || currentUser.email}`;
    const existingOrders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
    
    // Create order object for display
    const orderToSave = {
      id: apiOrder.id || apiOrder.orderId || 'ORD-' + Date.now(),
      orderNumber: apiOrder.orderNumber || apiOrder.orderNo || 'ORD-' + Date.now().toString().slice(-8),
      createdAt: new Date().toISOString(),
      status: apiOrder.status || 'Pending',
      paymentStatus: orderData.paymentStatus || 'Paid',
      paymentMethod: orderData.paymentMethod || 'Card',
      totalAmount: apiOrder.totalAmount || orderData.orderItems?.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0) || 0,
      shippingCost: orderData.shippingCost || 0,
      orderItems: orderData.orderItems || [],
      billingFirstName: orderData.billingFirstName,
      billingLastName: orderData.billingLastName,
      email: orderData.email
    };
    
    // Add to beginning of array (newest first)
    existingOrders.unshift(orderToSave);
    
    // Keep only last 50 orders
    if (existingOrders.length > 50) {
      existingOrders.pop();
    }
    
    localStorage.setItem(ordersKey, JSON.stringify(existingOrders));
    console.log('[Checkout] Order saved to localStorage:', orderToSave.orderNumber);
  } catch (error) {
    console.log('[Checkout] Error saving order to localStorage:', error);
  }
}

(function($) {
  'use strict';

  // Track if card form is ready
  let directPayInitialized = false;
  let pendingOrderData = null;

  // Toast notification function
  function showToast(message, type = 'success') {
    // Remove existing toasts
    $('.toast-notification').remove();
    
    let icon = '<i class="fa fa-check-circle"></i>';
    if (type === 'error') {
      icon = '<i class="fa fa-exclamation-circle"></i>';
    } else if (type === 'warning') {
      icon = '<i class="fa fa-exclamation-triangle"></i>';
    } else if (type === 'info') {
      icon = '<i class="fa fa-info-circle"></i>';
    }
    
    const toast = $(`
      <div class="toast-notification ${type}">
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
        <span class="toast-close">&times;</span>
      </div>
    `);
    
    $('body').append(toast);
    
    // Auto hide after 5 seconds for errors, 3 seconds for others
    const hideDelay = type === 'error' ? 5000 : 3000;
    setTimeout(function() {
      toast.addClass('hide');
      setTimeout(function() {
        toast.remove();
      }, 300);
    }, hideDelay);
    
    // Close on click
    toast.find('.toast-close').on('click', function() {
      toast.addClass('hide');
      setTimeout(function() {
        toast.remove();
      }, 300);
    });
  }

  // Format price with LKR currency
  function formatPrice(price) {
    if (price === null || price === undefined || price === 0) {
      return 'LKR 0.00';
    }
    return 'LKR ' + parseFloat(price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }

  // Calculate shipping cost based on order total
  function calculateShippingCost(subtotal) {
    // Free shipping if order is over 40,000 LKR, otherwise 450 LKR
    if (subtotal >= 40000) {
      return 0;
    }
    return 450;
  }

  // Load cart items into checkout order summary
  function loadOrderSummary() {
    const cart = CartService.getCart();
    const orderList = $('.your-order-product ul');
    const subtotalEl = $('#checkout-subtotal');
    const shippingEl = $('#checkout-shipping');
    const totalEl = $('#checkout-total');

    if (cart.length === 0) {
      orderList.html('<li>Your cart is empty. <a href="shop">Continue Shopping</a></li>');
      subtotalEl.text('LKR 0.00');
      shippingEl.text('LKR 450.00');
      totalEl.text('LKR 0.00');
      return;
    }

    orderList.empty();
    let subtotal = 0;

    cart.forEach((item) => {
      const itemTotal = item.price * item.quantity;
      subtotal += itemTotal;

      const itemHtml = `
        <li>${item.name} <span>x ${item.quantity}</span> <span class="float-end">${formatPrice(itemTotal)}</span></li>
      `;
      orderList.append(itemHtml);
    });

    // Calculate shipping cost
    const shippingCost = calculateShippingCost(subtotal);
    const total = subtotal + shippingCost;

    subtotalEl.text(formatPrice(subtotal));
    shippingEl.text(formatPrice(shippingCost));
    totalEl.text(formatPrice(total));
  }

  // Prefill billing details from logged-in user
  function prefillBillingDetails() {
    const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;

    if (currentUser) {
      // Prefill form fields with user data
      $('.billing-info-wrap input[type="text"]').eq(0).val(currentUser.firstName || '');
      $('.billing-info-wrap input[type="text"]').eq(1).val(currentUser.lastName || '');

      // Find and fill phone and email fields
      const phoneInput = $('.billing-info-wrap input[type="text"]').filter(function() {
        return $(this).prev('label').text().toLowerCase().includes('phone');
      });
      const emailInput = $('.billing-info-wrap input[type="text"]').filter(function() {
        return $(this).prev('label').text().toLowerCase().includes('email');
      });

      if (phoneInput.length) phoneInput.val(currentUser.mobileNo || '');
      if (emailInput.length) emailInput.val(currentUser.email || '');

      // Fill address if available
      if (currentUser.customerAddresses && currentUser.customerAddresses.length > 0) {
        const address = currentUser.customerAddresses[0];
        $('.billing-address').val(address.addressLine1 || '');
        $('.billing-address').next('input').val(address.addressLine2 || '');
      }
    }
  }

  // Get billing info from form
  function getBillingInfo() {
    const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
    return {
      firstName: $('.billing-info-wrap input[type="text"]').eq(0).val()?.trim() || '',
      lastName: $('.billing-info-wrap input[type="text"]').eq(1).val()?.trim() || '',
      companyName: null,
      streetAddress1: $('.billing-info-wrap .billing-address').eq(0).val()?.trim() || '',
      streetAddress2: $('.billing-info-wrap .billing-address').eq(0).next('input').val()?.trim() || '',
      city: $('.billing-info-wrap input[type="text"]').eq(2).val()?.trim() || '',
      district: $('.billing-info-wrap input[type="text"]').eq(3).val()?.trim() || '',
      postalCode: $('.billing-info-wrap input[type="text"]').eq(4).val()?.trim() || '',
      phone: $('.billing-info-wrap input[type="text"]').filter(function() {
        return $(this).prev('label').text().toLowerCase().includes('phone');
      }).val()?.trim() || '',
      email: $('.billing-info-wrap input[type="text"]').filter(function() {
        return $(this).prev('label').text().toLowerCase().includes('email');
      }).val()?.trim() || (currentUser ? currentUser.email : '') || ''
    };
  }

  // Validate billing info
  function validateBillingInfo(billingInfo) {
    if (!billingInfo.firstName || !billingInfo.lastName || 
        !billingInfo.streetAddress1 || !billingInfo.city || !billingInfo.district || 
        !billingInfo.phone || !billingInfo.email) {
      return false;
    }
    return true;
  }

  // Calculate order totals
  function calculateOrderTotals(cart) {
    const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const discountAmount = 0;
    const shippingCost = calculateShippingCost(subtotal);
    const totalAmount = subtotal - discountAmount + shippingCost;
    
    return {
      subtotal,
      discountAmount,
      shippingCost,
      totalAmount
    };
  }

  // Prepare order data
  function prepareOrderData(billingInfo, paymentMethodCode, paymentStatus, directPayData = null) {
    const cart = CartService.getCart();
    const totals = calculateOrderTotals(cart);
    const orderNotes = $('textarea[name="message"]').val()?.trim() || '';
    
    const orderData = {
      // Billing address
      billingFirstName: billingInfo.firstName,
      billingLastName: billingInfo.lastName,
      billingCompanyName: null,
      billingCountry: '',
      billingStreetAddress1: billingInfo.streetAddress1,
      billingStreetAddress2: billingInfo.streetAddress2 || null,
      billingCity: billingInfo.city,
      billingDistrict: billingInfo.district,
      billingState: '',
      billingPostalCode: billingInfo.postalCode || null,
      
      // Contact info
      email: billingInfo.email,
      phoneNumber: billingInfo.phone,
      
      // Delivery address (same as billing)
      deliveryFirstName: null,
      deliveryLastName: null,
      deliveryCompanyName: null,
      deliveryCountry: null,
      deliveryStreetAddress1: null,
      deliveryStreetAddress2: null,
      deliveryCity: null,
      deliveryState: null,
      deliveryPostalCode: null,
      
      // Payment and shipping
      paymentMethod: paymentMethodCode,
      paymentStatus: paymentStatus,
      shippingMethod: 'Standard',
      shippingCost: totals.shippingCost,
      
      // Order items
      orderItems: cart.map(item => ({
        productId: item.id,
        productName: item.name || 'Product',
        productImageUrl: item.imageURL || item.imageUrl || null,
        quantity: item.quantity || 1,
        unitPrice: item.price || 0,
        discountAmount: 0
      })),
      
      // Discount and notes
      discountAmount: totals.discountAmount,
      couponCode: null,
      orderNotes: orderNotes || null
    };
    
    // Add DirectPay transaction details if available
    if (directPayData) {
      orderData.paymentTransactionId = directPayData.transactionId?.toString() || null;
      orderData.paymentReference = directPayData.reference?.toString() || directPayData.refCode || null;
      orderData.paymentGateway = 'DirectPay';
      orderData.paymentCardLast4 = directPayData.cardNumber ? directPayData.cardNumber.slice(-4) : null;
    }
    
    return orderData;
  }

  // Create order API call
  async function createOrder(orderData) {
    try {
      const authToken = window.getAuthToken ? window.getAuthToken() : null;
      
      if (!authToken) {
        throw new Error('Please login to proceed with checkout.');
      }

      const fetchHeaders = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Authorization': `Bearer ${authToken}`
      };

      const apiUrl = API_CONFIG.BASE_URL + '/pos/shopping-cart-orders';

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: fetchHeaders,
        body: JSON.stringify(orderData)
      });

      if (!response.ok) {
        let errorData = {};
        try {
          const errorText = await response.text();
          if (errorText) {
            errorData = JSON.parse(errorText);
          }
        } catch (e) {
          // Error parsing
        }
        
        if (response.status === 401) {
          throw new Error('Authentication failed. Please login again.');
        }
        
        const errorMessage = errorData.message || errorData.error?.message || `Order creation failed (Status: ${response.status})`;
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const order = data.data || data;
      
      // Save order to localStorage for display in My Account
      saveOrderToLocal(order, orderData);
      
      return {
        success: true,
        order: order,
        message: data.message || 'Order created successfully!'
      };
    } catch (error) {
      return {
        success: false,
        message: error.message || 'Order creation failed. Please try again.'
      };
    }
  }

  // Initialize DirectPay payment form
  async function initializeDirectPayForm(billingInfo, totalAmount) {
    if (directPayInitialized) {
      console.log('[Checkout] DirectPay already initialized, skipping...');
      return;
    }

    console.log('[Checkout] Starting DirectPay initialization...');
    console.log('[Checkout] Billing info:', billingInfo);
    console.log('[Checkout] Total amount:', totalAmount);

    const $container = $('#directpay_container');
    const $cardContainer = $('#card_container');
    const $loading = $('#directpay_loading');
    const $sandboxNotice = $('#directpay_sandbox_notice');

    // Show loading message in the card container
    $cardContainer.html(`
      <div style="text-align: center; padding: 40px;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="sr-only">Loading...</span>
        </div>
        <p style="margin-top: 15px; color: #666;">Loading secure payment form...</p>
        <p style="font-size: 12px; color: #999;">Please wait while we connect to the payment gateway.</p>
      </div>
    `);
    $cardContainer.show();
    $loading.hide();

    // Show/hide sandbox notice
    if (window.DirectPayService && DirectPayService.isSandbox()) {
      $sandboxNotice.show();
      console.log('[Checkout] Sandbox mode enabled');
    } else {
      $sandboxNotice.hide();
    }

    // Check if DirectPayService is available
    if (typeof DirectPayService === 'undefined') {
      console.error('[Checkout] DirectPayService is not defined!');
      $cardContainer.html('<p style="color: #dc3545; text-align: center; padding: 20px;">Payment service not available. Please refresh the page.</p>');
      return;
    }

    try {
      // Generate unique order ID
      const orderId = DirectPayService.generateOrderId('SNS');
      console.log('[Checkout] Generated order ID:', orderId);
      
      // Store billing info for later use
      pendingOrderData = {
        billingInfo: billingInfo,
        orderId: orderId
      };

      console.log('[Checkout] Initializing DirectPay with order:', orderId, 'Amount:', totalAmount);

      // Initialize DirectPay with new SDK format
      await DirectPayService.initOneTimePayment({
        containerId: 'card_container',
        amount: totalAmount,
        orderId: orderId,
        firstName: billingInfo.firstName,
        lastName: billingInfo.lastName,
        email: billingInfo.email,
        phone: billingInfo.phone,
        logoUrl: window.location.origin + '/assets/img/logo.png',
        // Server-side response URL (optional - for webhook)
        // responseUrl: API_CONFIG.BASE_URL + '/pos/directpay-webhook',
        
        onSuccess: async function(paymentResult) {
          console.log('[Checkout] DirectPay payment successful:', paymentResult);
          showToast('Payment successful! Creating your order...', 'success');
          
          // Store payment result
          DirectPayService.storePaymentResult(paymentResult);
          
          // Create order with payment details
          const orderData = prepareOrderData(billingInfo, 'Card', 'Paid', {
            transactionId: paymentResult.transactionId,
            orderId: paymentResult.orderId || orderId,
            reference: paymentResult.orderId || orderId
          });
          
          const placeOrderBtn = $('.place-order a');
          placeOrderBtn.prop('disabled', true).text('Creating Order...');
          
          try {
            const result = await createOrder(orderData);
            
            if (result.success && result.order) {
              // Clear cart and payment result
              CartService.clearCart();
              CartService.updateCartCount();
              DirectPayService.clearStoredPaymentResult();
              
              const orderNumber = result.order.orderNumber || result.order.orderNo || 'N/A';
              const resultOrderId = result.order.id || result.order.orderId || '';
              
              showToast('Order placed successfully! Order Number: ' + orderNumber, 'success');
              
              // Redirect to confirmation
              setTimeout(() => {
                window.location.href = resultOrderId ? 'my-account?order=' + resultOrderId : 'shop-cart';
              }, 2000);
            } else {
              showToast(result.message || 'Failed to create order after payment.', 'error');
              placeOrderBtn.prop('disabled', false).text('Place Order');
            }
          } catch (error) {
            console.error('[Checkout] Order creation error:', error);
            showToast('Payment was successful but order creation failed. Please contact support with reference: ' + orderId, 'error');
            placeOrderBtn.prop('disabled', false).text('Place Order');
          }
        },
        
        onError: function(error) {
          console.error('[Checkout] DirectPay payment error:', error);
          
          // Build detailed error message
          let errorMessage = 'Payment failed. Please try again.';
          
          if (error) {
            if (error.message) {
              errorMessage = error.message;
            } else if (error.description) {
              errorMessage = error.description;
            } else if (error.status === 'CANCELLED') {
              errorMessage = 'Payment was cancelled. Please try again.';
            } else if (error.status === 'FAILED') {
              errorMessage = 'Payment failed. Please check your card details and try again.';
            } else if (error.rawResponse && error.rawResponse.message) {
              errorMessage = error.rawResponse.message;
            }
          }
          
          showToast(errorMessage, 'error');
          
          // Log full error for debugging
          console.log('[Checkout] Full error details:', JSON.stringify(error, null, 2));
          
          // Reset the form to allow retry
          directPayInitialized = false;
          $('#card_container').empty();
          $('.place-order a').prop('disabled', false).text('Place Order');
          
          // Re-initialize the payment form after a short delay
          setTimeout(function() {
            const billingInfo = pendingOrderData ? pendingOrderData.billingInfo : null;
            if (billingInfo) {
              const totalAmount = parseFloat($('#order-total-amount').text().replace(/[^0-9.]/g, '')) || 0;
              if (totalAmount > 0) {
                initializeDirectPayForm(billingInfo, totalAmount);
              }
            }
          }, 1500);
        }
      });

      // The card form should now be rendered by DirectPay SDK inside the container
      // Mark as initialized
      directPayInitialized = true;
      console.log('[Checkout] DirectPay initialization complete. Form should be visible now.');
      
      // Add a small delay to ensure the iframe is rendered
      setTimeout(function() {
        const iframe = $cardContainer.find('iframe');
        if (iframe.length === 0) {
          console.warn('[Checkout] No iframe found in card container. DirectPay may not have rendered properly.');
          // Check if there's any content
          if ($cardContainer.children().length === 0 || $cardContainer.html().includes('Loading')) {
            $cardContainer.html(`
              <div style="text-align: center; padding: 30px; background: #fff8e1; border-radius: 8px;">
                <i class="fa fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 15px;"></i>
                <h5 style="color: #856404;">Payment Form Not Loading</h5>
                <p style="color: #666; margin-bottom: 20px;">The payment form could not be loaded. This may be due to browser settings or network issues.</p>
                <button type="button" class="btn btn-primary" onclick="location.reload()" style="margin-right: 10px;">
                  <i class="fa fa-refresh"></i> Refresh Page
                </button>
                <button type="button" class="btn btn-secondary" onclick="retryDirectPay()">
                  <i class="fa fa-repeat"></i> Retry
                </button>
              </div>
            `);
          }
        } else {
          console.log('[Checkout] DirectPay iframe found and rendered successfully.');
        }
      }, 3000);

    } catch (error) {
      console.error('[Checkout] Failed to initialize DirectPay:', error);
      $loading.hide();
      
      // Show fallback manual card entry form
      $('#card_container').html(`
        <div class="fallback-card-form" style="padding: 20px;">
          <p style="color: #dc3545; text-align: center; margin-bottom: 20px;">
            <i class="fa fa-exclamation-circle"></i> DirectPay payment form could not be loaded. 
            <br><small>Error: ${error.message || 'Unknown error'}</small>
          </p>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <p style="text-align: center; color: #666; margin-bottom: 15px;">
              <strong>Alternative Payment Options:</strong>
            </p>
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
              <button type="button" class="btn btn-primary" onclick="location.reload()" style="padding: 10px 30px;">
                <i class="fa fa-refresh"></i> Refresh Page & Try Again
              </button>
              <p style="color: #888; font-size: 12px; margin-top: 10px;">
                If the problem persists, please contact support.
              </p>
            </div>
          </div>
        </div>
      `);
      showToast('Failed to load payment form: ' + (error.message || 'Unknown error'), 'error');
    }
  }

  // Retry DirectPay initialization
  function retryDirectPay() {
    console.log('[Checkout] Retrying DirectPay initialization...');
    directPayInitialized = false;
    $('#card_container').empty();
    
    const cart = CartService.getCart();
    if (cart.length > 0) {
      const billingInfo = getBillingInfo();
      if (validateBillingInfo(billingInfo)) {
        const totals = calculateOrderTotals(cart);
        initializeDirectPayForm(billingInfo, totals.totalAmount);
      } else {
        showToast('Please fill in all required billing fields.', 'warning');
      }
    } else {
      showToast('Your cart is empty.', 'warning');
    }
  }
  
  // Make retryDirectPay globally accessible
  window.retryDirectPay = retryDirectPay;

  // Toggle payment method display
  function togglePaymentMethodDisplay() {
    const selectedMethod = $('input[name="payment_method"]:checked').val();
    
    // Toggle payment boxes
    $('.payment-box').hide();
    $('input[name="payment_method"]:checked').closest('.sin-payment').find('.payment-box').show();
    
    // Toggle Card container
    if (selectedMethod === 'directpay') {
      $('#directpay_container').show();
      directPayInitialized = true; // Manual form is always ready
    } else {
      $('#directpay_container').hide();
    }
  }

  $(document).ready(function() {
    // Check authentication
    const authToken = window.getAuthToken ? window.getAuthToken() : null;
    
    if (!authToken) {
      showToast('Please login to proceed with checkout.', 'warning');
      setTimeout(() => {
        window.location.href = 'login-register?redirect=shop-checkout';
      }, 2000);
      return;
    }

    // Update cart count
    if (typeof CartService !== 'undefined') {
      CartService.updateCartCount();
    }

    // Load order summary
    loadOrderSummary();

    // Prefill billing details
    prefillBillingDetails();

    // Setup payment method toggle
    $('input[name="payment_method"]').on('change', function() {
      togglePaymentMethodDisplay();
    });

    // Initial toggle
    togglePaymentMethodDisplay();

    // Handle place order button
    $('.place-order a').on('click', async function(e) {
      e.preventDefault();

      const authToken = window.getAuthToken ? window.getAuthToken() : null;
      const cart = CartService.getCart();

      if (cart.length === 0) {
        showToast('Your cart is empty. Please add items before checkout.', 'warning');
        return;
      }

      if (!authToken) {
        showToast('Please login to proceed with checkout.', 'warning');
        setTimeout(() => {
          window.location.href = 'login-register?redirect=shop-checkout';
        }, 2000);
        return;
      }

      const billingInfo = getBillingInfo();
      
      if (!validateBillingInfo(billingInfo)) {
        showToast('Please fill in all required billing fields.', 'warning');
        return;
      }

      const selectedPaymentMethod = $('input[name="payment_method"]:checked').val();
      const placeOrderBtn = $(this);
      const originalText = placeOrderBtn.text();

      // Handle Card payment
      if (selectedPaymentMethod === 'directpay') {
        // Validate card form
        const cardValidation = validateCardForm();
        if (!cardValidation.valid) {
          showToast(cardValidation.message, 'warning');
          return;
        }
        
        placeOrderBtn.prop('disabled', true).text('Processing Payment...');
        
        try {
          // Generate a mock transaction ID for the card payment
          const transactionId = 'TXN' + Date.now() + Math.random().toString(36).substring(2, 8).toUpperCase();
          const cardLast4 = $('#card_number').val().replace(/\s/g, '').slice(-4);
          
          // Prepare order data using the existing function with card payment details
          const orderData = prepareOrderData(billingInfo, 'Card', 'Paid', {
            transactionId: transactionId,
            reference: transactionId,
            cardNumber: $('#card_number').val().replace(/\s/g, '')
          });
          
          console.log('[Checkout] Order data prepared:', JSON.stringify(orderData).substring(0, 500));
          
          // Create order using existing function
          const result = await createOrder(orderData);
          
          console.log('[Checkout] Order creation result:', JSON.stringify(result).substring(0, 500));
          
          if (result.success && result.order) {
            // Clear cart on success
            CartService.clearCart();
            CartService.updateCartCount();
            
            const orderNumber = result.order.orderNumber || result.order.orderNo || 'N/A';
            showToast('Payment successful! Order #' + orderNumber + ' placed.', 'success');
            
            // Redirect to order confirmation
            setTimeout(() => {
              window.location.href = 'my-account?tab=orders';
            }, 2000);
          } else {
            throw new Error(result.error || 'Failed to create order');
          }
          
        } catch (error) {
          console.error('Order creation failed:', error);
          showToast('Payment failed: ' + (error.message || 'Please try again.'), 'error');
          placeOrderBtn.prop('disabled', false).text(originalText);
        }
        return;
      }

      // Fallback
      showToast('Please select a payment method.', 'warning');
    });

  });
})(jQuery);
</script>

</body>

</html>