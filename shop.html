<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/">

    <title>Shop - Sensory - Kids Toys Store</title>

    <!--== Favicon ==-->
    <link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon" />

    <!--== Google Fonts ==-->
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One:400" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!--== Bootstrap CSS ==-->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet"/>
    <!--== Font-awesome Icons CSS ==-->
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet"/>
    <!--== Pe Icon 7 Min Icons CSS ==-->
    <link href="/assets/css/pe-icon-7-stroke.min.css" rel="stylesheet"/>
    <!--== Ionicons CSS ==-->
    <link href="/assets/css/ionicons.css" rel="stylesheet"/>
    <!--== Animate CSS ==-->
    <link href="/assets/css/animate.css" rel="stylesheet"/>
    <!--== Aos CSS ==-->
    <link href="/assets/css/aos.css" rel="stylesheet"/>
    <!--== FancyBox CSS ==-->
    <link href="/assets/css/jquery.fancybox.min.css" rel="stylesheet"/>
    <!--== Slicknav CSS ==-->
    <link href="/assets/css/slicknav.css" rel="stylesheet"/>
    <!--== Swiper CSS ==-->
    <link href="/assets/css/swiper.min.css" rel="stylesheet"/>
    <!--== Slick CSS ==-->
    <link href="/assets/css/slick.css" rel="stylesheet"/>
    <!--== Rangeslider CSS ==-->
    <link href="/assets/css/rangeslider.css" rel="stylesheet"/>
    <!--== Main Style CSS ==-->
    <link href="/assets/css/style.css" rel="stylesheet" />

</head>

<body>

<!--wrapper start-->
<div class="wrapper page-shop-wrapper">

  <!--== Start Header Wrapper ==-->
  <header class="header-wrapper">
    <div class="header-top">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-sm-5 col-md-4 col-lg-6">
            <div class="header-info-left">
            </div>
          </div>
          <div class="col-xs-12 col-sm-7 col-md-8 col-lg-6 sm-pl-0 xs-pl-15 header-top-right">
            <div class="header-info">
              <a href="tel://+94761487787"><i class="fa fa-phone"></i> +94761487787</a>
              <a href="mailto:sensorysl12@gmail.com"><i class="fa fa-envelope"></i> sensorysl12@gmail.com</a>
              <a href="login-register"><i class="fa fa-user"></i> Account</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-middle">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-12">
            <div class="header-align">
              <div class="header-align-left">
                <div class="header-logo-area">
                  <a href="/">
                    <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                    <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
                  </a>
                </div>
              </div>
              <div class="header-align-center">
                <div class="header-search-box">
                  <form action="#" method="post">
                    <div class="form-input-item">
                      <label for="search" class="sr-only">Search Everything</label>
                      <input type="text" id="search" placeholder="Search Everything">
                      <button type="submit" class="btn-src">
                        <i class="pe-7s-search"></i>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
              <div class="header-align-right">
                <div class="header-action-area">
                  <div class="header-action-wishlist">
                    <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                      <span class="wishlist-count">0</span>
                      <i class="pe-7s-like"></i>
                    </button>
                  </div>
                  <div class="header-action-cart">
                    <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                      <span class="cart-count">0</span>
                      <i class="pe-7s-shopbag"></i>
                    </button>
                  </div>
                  <button class="btn-menu d-md-none">
                    <i class="ion-navicon"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-area header-default sticky-header">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-4 col-sm-6 col-lg-2">
            <div class="header-logo-area">
              <a href="/">
                <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
              </a>
            </div>
          </div>
          <div class="col-lg-8 sticky-md-none">
            <div class="header-navigation-area d-none d-md-block">
              <ul class="main-menu nav position-relative" id="main-nav-menu">
                <li><a class="ml--2" href="/">Home</a></li>
                <!-- Main category links are injected by JS (up to 5 categories) -->
              </ul>
            </div>
          </div>
          <div class="col-8 col-sm-6 col-lg-2">
            <div class="header-action-area">
              <div class="header-action-search">
                <button class="btn-search btn-search-menu">
                  <i class="pe-7s-search"></i>
                </button>
              </div>
              <div class="header-action-login">
                <button class="btn-login" onclick="window.location.href='login-register'">
                  <i class="pe-7s-users"></i>
                </button>
              </div>
              <div class="header-action-wishlist">
                <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                  <span class="wishlist-count">0</span>
                  <i class="pe-7s-like"></i>
                </button>
              </div>
              <div class="header-action-cart">
                <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                  <span class="cart-count">0</span>
                  <i class="pe-7s-shopbag"></i>
                </button>
              </div>
              <button class="btn-menu d-lg-none">
                <i class="ion-navicon"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <!--== End Header Wrapper ==-->
  
  <main class="main-content">
    <!--== Start Page Title Area ==-->
    <section class="page-title-area">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-12 m-auto">
            <div class="page-title-content text-center">
              <h2 class="title">Product</h2>
              <!-- <div class="bread-crumbs"><a href="/"> Home </a><span class="breadcrumb-sep"> // </span><span class="active"> Product</span></div> -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--== End Page Title Area ==-->

    <!--== Start Shop Area Wrapper ==-->
    <div class="product-area product-grid-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-9 order-0 order-lg-1">
            <div class="shop-content">
              <div class="shop-toolbar-wrap">
                <div class="product-showing-status">
                  <p class="count-result"></p>
                </div>
                <div class="product-view-mode">
                  <nav>
                    <div class="nav nav-tabs active" id="nav-tab" role="tablist">
                      <button class="nav-link active" id="column-three-tab" data-bs-toggle="tab" data-bs-target="#column-three" type="button" role="tab" aria-controls="column-three" aria-selected="true"><i class="fa fa-th"></i></button>

                      <button class="nav-link" id="nav-list-tab" data-bs-toggle="tab" data-bs-target="#nav-list" type="button" role="tab" aria-controls="nav-list" aria-selected="false"><i class="fa fa-list"></i></button>

                      <button class="nav-link" id="column-two-tab" data-bs-toggle="tab" data-bs-target="#column-two" type="button" role="tab" aria-controls="column-two" aria-selected="true"><i class="fa fa-th-large"></i></button>
                    </div>
                  </nav>
                </div>
                <div class="product-sorting-menu product-sorting">
                  <span class="current">Sort By : <span id="current-sort-label"> Default <i class="fa fa-angle-down"></i></span></span>
                  <ul>
                    <li class="active" data-sort="default"><a href="javascript:void(0)" onclick="applySortOrder('default')" class="active">Sort by Default</a></li>
                    <li data-sort="popularity"><a href="javascript:void(0)" onclick="applySortOrder('popularity')">Sort by Popularity</a></li>
                    <li data-sort="rated"><a href="javascript:void(0)" onclick="applySortOrder('rated')">Sort by Rated</a></li>
                    <li data-sort="latest"><a href="javascript:void(0)" onclick="applySortOrder('latest')">Sort by Latest</a></li>
                    <li data-sort="price-low"><a href="javascript:void(0)" onclick="applySortOrder('price-low')">Sort by Price: Low to High <i class="fa fa-arrow-up"></i></a></li>
                    <li data-sort="price-high"><a href="javascript:void(0)" onclick="applySortOrder('price-high')">Sort by Price: High to Low <i class="fa fa-arrow-down"></i></a></li>
                  </ul>
                </div>
              </div>
              <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="column-three" role="tabpanel" aria-labelledby="column-three-tab">
                  <div id="search-results-message" style="display: none; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #f379a7; border-radius: 4px;">
                    <p style="margin: 0; display: flex; justify-content: space-between; align-items: center;">
                      <span><strong>Search Results for:</strong> <span id="search-term-display"></span></span>
                      <button onclick="clearSearch()" style="background: #f379a7; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-size: 14px;">Clear Search</button>
                    </p>
                  </div>
                  <div id="active-filters-display" style="display: none; margin-bottom: 15px; padding: 8px 12px; background-color: #e8f4f8; border-left: 3px solid #2196F3; border-radius: 3px;">
                    <div id="active-filters-list" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 13px;">
                      <span style="font-weight: 600; color: #1976D2; margin-right: 5px;">Filters:</span>
                      <!-- Active filters will be displayed here -->
                    </div>
                  </div>
                  <div class="row" id="products-container">
                    <!-- Products will be loaded dynamically here -->
                  </div>
                </div>
                <div class="tab-pane fade" id="nav-list" role="tabpanel" aria-labelledby="nav-list-tab">
                  <div class="row" id="products-container-list">
                    <!-- Products will be loaded dynamically here -->
                  </div>
                </div>
                <div class="tab-pane fade" id="column-two" role="tabpanel" aria-labelledby="column-two-tab">
                  <div class="row" id="products-container-two">
                    <!-- Products will be loaded dynamically here -->
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="pagination-area mb-md-50">
                    <nav>
                      <!-- Pagination will be loaded dynamically here -->
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 order-1 order-lg-0">
            <div class="sidebar-area shop-sidebar-area">
              <div class="widget-item">
                <div class="widget-title">
                  <h3 class="title">Product Categories</h3>
                </div>
                <div class="widget-body">
                  <div class="widget-categories">
                    <ul id="product-categories-list">
                      <!-- Categories will be loaded dynamically here -->
                    </ul>
                  </div>
                </div>
              </div>
              <div class="widget-item">
                <div class="widget-filter">
                  <div class="widget-title">
                    <h3 class="title">Price Filter</h3>
                  </div>
                  <div class="widget-body">
                    <div class="widget-price-filter">
                      <div class="price-input-fields" style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="price-input-group">
                          <label for="price-min-input" style="display: block; margin-bottom: 5px; font-weight: 500;">Min Amount (LKR)</label>
                          <input type="number" id="price-min-input" class="form-control" placeholder="Enter min amount" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="price-input-group">
                          <label for="price-max-input" style="display: block; margin-bottom: 5px; font-weight: 500;">Max Amount (LKR)</label>
                          <input type="number" id="price-max-input" class="form-control" placeholder="Enter max amount" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                          <button type="button" id="apply-price-filter" class="btn btn-theme" style="flex: 1; padding: 10px;">Apply</button>
                          <button type="button" id="reset-price-filter" class="btn btn-outline-secondary" onclick="window.resetPriceFilter && window.resetPriceFilter()" style="flex: 1; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; color: #333; cursor: pointer;">Reset</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="widget-item">
                <div class="widget-filter">
                  <div class="widget-title">
                    <h3 class="title">Availability</h3>
                  </div>
                  <div class="widget-body">
                    <div class="widget-availability-filter">
                      <div class="form-check" style="margin-bottom: 10px;">
                        <input class="form-check-input" type="checkbox" id="show-in-stock" checked style="cursor: pointer;">
                        <label class="form-check-label" for="show-in-stock" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                          <span style="width: 10px; height: 10px; background: #4CAF50; border-radius: 50%; display: inline-block;"></span>
                          In Stock <span id="in-stock-count" style="color: #888; font-size: 12px;">(0)</span>
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-out-of-stock" checked style="cursor: pointer;">
                        <label class="form-check-label" for="show-out-of-stock" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                          <span style="width: 10px; height: 10px; background: #f44336; border-radius: 50%; display: inline-block;"></span>
                          Out of Stock <span id="out-of-stock-count" style="color: #888; font-size: 12px;">(0)</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--== End Shop Area Wrapper ==-->
  </main>

  <!--== Start Footer Area Wrapper ==-->
  <footer class="footer-area default-style" >
    <div class="footer-main">
      <div class="container">
        <div class="row">
          <div class="col-12 col-lg-4">
            <div class="widget-item item-style3">
              <div class="about-widget">
                <a class="footer-logo" href="/">
                  <img src="/assets/img/logo-light.png" alt="Logo">
                </a>
                <p>
                  Sensory a brand of ANKH Trading Pvt Ltd is a curated destination for premium sensory books, toddler sensory, and early learning products, created to support holistic childhood development. We bring together safe, reliable, and thoughtfully designed sensory essentials in one place—making it easier for parents, educators, and retailers to access quality products that encourage learning through play, exploration, and imagination.
0 
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-2">
            <div class="widget-item item-style1">
              <h4 class="widget-title">Quick Links</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-1">Quick Links</h4>
              <div id="dividerId-1" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap">
                  <ul class="nav-menu nav item-hover-style">
                    <li><a href="/">- Home</a></li>
                    <li><a href="about">- About</a></li>
                    <li><a href="shop">- Shop</a></li>
                    <li><a href="contact">- Contact</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="widget-item item-style2">
              <h4 class="widget-title">Company</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-3">Company</h4>
              <div id="dividerId-3" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap item-hover-style">
                  <ul class="nav-menu nav">
                    <li><a href="terms-and-conditions">- Terms & Conditions</a></li>
                    <li><a href="privacy-policy">- Privacy Policy</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="widget-item">
              <h4 class="widget-title">Store Information.</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-4">Store Information.</h4>
              <div id="dividerId-4" class="collapse widget-collapse-body">
                <p class="widget-address">296/A/1 , Level 2 <br>New Kandy Road, <br>Kothalawala, <br>Kaduwela,
                    <br>Sri Lanka</p>
                  <ul class="widget-contact-info">
                    <li>Phone: <a href="tel://+94761487787">+94761487787</a></li>
                    <li>Email: <a href="mailto:sensorysl12@gmail.com">sensorysl12@gmail.com</a></li>
                  </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <div class="footer-bottom-content">
          <div class="row text-center">
            <div class="col-sm-12">
              <div class="widget-copyright">
                <p><i class="fa fa-copyright"></i> 2025 <span>Sensory. </span> All Rights Reserved</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-shape bg-img" data-bg-img="/assets/img/photos/footer1.png"></div>
  </footer>
  <!--== End Footer Area Wrapper ==-->

</div>
<!--wrapper end-->
  
  <!--== Scroll Top Button ==-->
  <div class="scroll-to-top"><span class="fa fa-angle-double-up"></span></div>

  <!--== Start Product Quick View ==-->
  <aside class="product-quick-view-modal">
    <div class="product-quick-view-inner">
      <div class="product-quick-view-content">
        <button type="button" class="btn-close">
          <span class="pe-7s-close"><i class="lastudioicon-e-remove"></i></span>
        </button>
        <div class="row row-gutter-0">
          <div class="col-lg-6 col-md-6 col-12">
            <div class="thumb">
              <img id="quick-view-main-image" src="/assets/img/shop/quick-view1.jpg" alt="Image">
              <div class="product-image-thumbnails" id="quick-view-thumbnails">
                <!-- Thumbnails will be loaded dynamically -->
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-12">
            <div class="content" id="quick-view-content">
              <!-- Quick view content will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="canvas-overlay"></div>
  </aside>
  <!--== End Product Quick View ==-->

  <!--== Start Aside Cart ==-->
  <aside class="aside-cart-wrapper offcanvas offcanvas-end" tabindex="-1" id="AsideOffcanvasCart" aria-labelledby="offcanvasRightLabel">
    <div class="offcanvas-header">
      <h1 class="d-none" id="offcanvasRightLabel">Shopping Cart</h1>
      <button class="btn-aside-cart-close" data-bs-dismiss="offcanvas" aria-label="Close">Shopping Cart <i class="ion-ios-close-empty"></i></button>
    </div>
    <div class="offcanvas-body">
      <ul class="aside-cart-product-list" id="aside-cart-items">
        <!-- Cart items will be loaded dynamically -->
      </ul>
      <div class="aside-cart-footer">
        <div class="cart-total">
          <h4>Total: <span id="aside-cart-total">LKR 0.00</span></h4>
        </div>
        <div class="group-btn">
          <a class="btn-product" href="shop-cart">View Cart</a>
          <a class="btn-product" href="shop-checkout">Checkout</a>
        </div>
      </div>
    </div>
  </aside>
  <!--== End Aside Cart ==-->

  <!--== Start Aside Search ==-->
  <aside class="aside-search-wrapper offcanvas offcanvas-top" tabindex="-1" id="AsideOffcanvasSearch" aria-labelledby="offcanvasTopLabel">
    <div class="offcanvas-header">
      <h5 class="d-none" id="offcanvasTopLabel">Aside Search</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"><i class="pe-7s-close"></i></button>
    </div>
    <div class="offcanvas-body">
      <div class="container pt--0 pb--0">
        <div class="search-box-form-wrap">
          <div class="search-note">
            <p>Start typing and press Enter to search</p>
          </div>
          <form action="#" method="post">
            <div class="search-form position-relative">
              <label for="search-input" class="visually-hidden">Search</label>
              <input id="search-input" type="search" class="form-control" placeholder="Search entire store…">
              <button class="btn-search" type="submit"><i class="ion-ios-search-strong"></i></button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </aside>
  <!--== End Aside Search ==-->

  <!--== Start Side Menu (theme off-canvas - same as index for mobile nav) ==-->
  <aside class="off-canvas-wrapper">
    <div class="off-canvas-inner">
      <div class="off-canvas-overlay d-none"></div>
      <div class="off-canvas-content">
        <div class="off-canvas-header">
          <div class="close-action">
            <button class="btn-close"><i class="pe-7s-close"></i></button>
          </div>
        </div>
        <div class="off-canvas-item">
          <div class="res-mobile-menu">
            <!-- Content auto-generated by Slicknav from .main-menu -->
          </div>
        </div>
        <div class="off-canvas-footer"></div>
      </div>
    </div>
  </aside>
  <!--== End Side Menu ==-->

  <!-- JS Vendor, Plugins & Activation Script Files -->
  <script src="/assets/js/jquery-main.js"></script>
  <script src="/assets/js/jquery-migrate.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  <script src="/assets/js/popper.min.js"></script>
  <script src="/assets/js/jquery.slicknav.js"></script>
  <script src="/assets/js/swiper.min.js"></script>
  <script src="/assets/js/fancybox.min.js"></script>
  <script src="/assets/js/slick.min.js"></script>
  <script src="/assets/js/rangeSlider.js"></script>
  <script src="/assets/js/jquery-zoom.min.js"></script>
  <script src="/assets/js/isotope.pkgd.min.js"></script>
  <script src="/assets/js/aos.min.js"></script>
  <script src="/assets/js/wow.min.js"></script>
  <script src="/assets/js/parallax.min.js"></script>
  <script src="/assets/js/jquery.appear.js"></script>
  <script src="/assets/js/jquery.countdown.min.js"></script>
  <script src="/assets/js/tippy.all.min.js"></script>
  <!--=== API Config Js ===-->
  <script src="/assets/js/config.js"></script>
  <!--=== Cart & Wishlist Service Js ===-->
  <script src="/assets/js/cart-service.js"></script>
  <!--=== API Service Js ===-->
  <script src="/assets/js/api-service.js"></script>
  <!--=== Custom Js ===-->
  <script src="/assets/js/custom.js"></script>
  <style>
    /* Active Category Styling */
    #product-categories-list li a.active {
      color: #f379a7 !important;
      font-weight: 600;
    }
    
    #product-categories-list li a.active:hover {
      color: #e06896 !important;
    }
    
    /* Product Quick View Modal - Centered and Scrollable */
    .product-quick-view-modal {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: hidden !important;
      padding: 20px !important;
    }
    
    .product-quick-view-modal.active {
      overflow: hidden !important;
    }
    
    .product-quick-view-inner {
      margin: 0 !important;
      max-height: 90vh !important;
      width: 100% !important;
      max-width: 1200px !important;
      display: flex !important;
      align-items: center !important;
      transform: translate(0, 0) !important;
    }
    
    .product-quick-view-content {
      max-height: 90vh !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      display: flex !important;
      flex-direction: column !important;
    }
    
    .product-quick-view-content .row {
      margin: 0 !important;
    }
    
    .product-quick-view-content .row > div {
      padding: 0 !important;
    }
    
    .product-quick-view-content .thumb {
      max-height: 90vh !important;
      overflow: visible !important;
      display: flex !important;
      flex-direction: column !important;
    }
    
    .product-quick-view-content .thumb img {
      object-fit: contain !important;
      max-height: 60vh !important;
      width: 100% !important;
      margin-top: 20px !important;
      margin-bottom: 15px !important;
    }
    
    .product-image-thumbnails {
      display: flex !important;
      gap: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 10px;
      flex-wrap: wrap;
      justify-content: center;
      min-height: 80px;
    }
    
    .product-image-thumbnails .thumbnail-item {
      width: 80px;
      height: 80px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 4px;
      overflow: hidden;
      transition: border-color 0.3s ease;
      margin: 5px;
    }
    
    .product-image-thumbnails .thumbnail-item:hover {
      border-color: #333;
    }
    
    .product-image-thumbnails .thumbnail-item.active {
      border-color: #007bff;
    }
    
    .product-image-thumbnails .thumbnail-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Prevent body scroll when modal is open */
    html.fix,
    body.fix {
      overflow: hidden !important;
      height: 100% !important;
    }
    
    body.fix {
      position: relative !important;
    }
    
    /* Toast Notification Styles */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 16px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideInRight 0.3s ease-out;
      font-size: 14px;
    }
    
    .toast-notification.success {
      background-color: #4CAF50;
    }
    
    .toast-notification.info {
      background-color: #2196F3;
    }
    
    .toast-notification .toast-icon {
      font-size: 20px;
    }
    
    .toast-notification .toast-message {
      flex: 1;
    }
    
    .toast-notification .toast-close {
      cursor: pointer;
      font-size: 18px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    
    .toast-notification .toast-close:hover {
      opacity: 1;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    .toast-notification.hide {
      animation: slideOutRight 0.3s ease-out forwards;
    }
    
    /* Stock badge styles */
    .stock-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      z-index: 10;
      text-transform: uppercase;
    }
    
    .stock-badge.out-of-stock {
      background-color: #dc3545;
      color: #fff;
    }
    
    .stock-badge.low-stock {
      background-color: #ffc107;
      color: #000;
    }
    
    .product-item.out-of-stock-item .product-thumb img {
      opacity: 0.6;
    }
    
    .product-item .product-thumb {
      position: relative;
    }
    
    .add-to-cart-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .stock-info {
      color: #28a745;
      margin-top: 5px;
    }
    
    .stock-info small {
      font-size: 12px;
    }
    
    .toast-notification.error {
      background-color: #dc3545;
    }
    
    .toast-notification.warning {
      background-color: #ffc107;
      color: #000;
    }
    
    /* Quick view modal stock indicator */
    .modal-stock-info {
      margin: 15px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .modal-stock-info.in-stock {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .modal-stock-info.out-of-stock {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .modal-stock-info.low-stock {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
  </style>
  <script>
  (function($) {
    'use strict';

    // Toast notification function
    function showToast(message, type = 'success') {
      // Remove existing toasts
      $('.toast-notification').remove();
      
      const icon = type === 'success' ? '<i class="ion-checkmark-circled"></i>' : '<i class="ion-information-circled"></i>';
      const toast = $(`
        <div class="toast-notification ${type}">
          <span class="toast-icon">${icon}</span>
          <span class="toast-message">${message}</span>
          <span class="toast-close">&times;</span>
        </div>
      `);
      
      $('body').append(toast);
      
      // Auto hide after 3 seconds
      setTimeout(function() {
        toast.addClass('hide');
        setTimeout(function() {
          toast.remove();
        }, 300);
      }, 3000);
      
      // Close on click
      toast.find('.toast-close').on('click', function() {
        toast.addClass('hide');
        setTimeout(function() {
          toast.remove();
        }, 300);
      });
    }

    // Render products function
    function renderProducts(products, containerId) {
      const container = $(containerId);
      if (!container || !container.length) {
        // Container not found
        return;
      }
      
      container.empty();
      
      if (!products || products.length === 0) {
        // Check what filters are active to provide a helpful message
        const urlParams = new URLSearchParams(window.location.search);
        const searchKeyword = urlParams.get('search') || '';
        const categoryId = urlParams.get('category');
        const hasPriceFilter = (priceRange.min > 0 || (priceRange.max > 0 && priceRange.max < 999999999));
        
        let noResultsMessage = 'No products found.';
        let suggestions = [];
        
        if (searchKeyword) {
          noResultsMessage = `No products found matching "<strong>${searchKeyword}</strong>".`;
          suggestions.push('Try different keywords');
          suggestions.push('Check your spelling');
        }
        if (categoryId) {
          suggestions.push('Try selecting a different category');
        }
        if (hasPriceFilter) {
          suggestions.push('Try adjusting the price range');
        }
        if (suggestions.length > 0) {
          noResultsMessage += '<br><small style="color: #666;">Suggestions: ' + suggestions.join(', ') + '</small>';
        }
        
        container.html(`
          <div class="col-12">
            <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
              <i class="pe-7s-search" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 15px;"></i>
              <p style="margin: 0; font-size: 16px;">${noResultsMessage}</p>
            </div>
          </div>
        `);
        return;
      }
      
      const defaultImage = 'https://www.holoimage.net/images/no-image.jpg';
      
      products.forEach((product) => {
        const productImage = (product.imageURL && product.imageURL.trim() !== '') ? product.imageURL : defaultImage;
        const productPrice = product.sellingPrice > 0 ? product.sellingPrice : (product.unitPrice > 0 ? product.unitPrice : 0);
        const formattedPrice = formatPrice(productPrice);
        
        // Get stock for this product (try both number and string keys)
        const productStock = stockMap.get(product.id) || stockMap.get(String(product.id)) || stockMap.get(Number(product.id)) || 0;
        const isOutOfStock = productStock <= 0;
        
        // Store minimal product data for cart/wishlist (include all price fields and images)
        const productData = {
          id: product.id,
          name: product.name,
          imageURL: product.imageURL,
          imageUrl: product.imageUrl,
          images: product.images || [],
          imageUrls: product.imageUrls || [],
          sellingPrice: product.sellingPrice || 0,
          unitPrice: product.unitPrice || 0,
          description: product.description || '',
          maxStock: productStock
        };
        
        // Determine column class based on container - 3 products per row
        let colClass = 'col-sm-6 col-md-4 col-lg-4';
        if (containerId === '#products-container-list') {
          colClass = 'col-12 product-items-list';
        } else if (containerId === '#products-container-two') {
          colClass = 'col-sm-6';
        }
        
        let productHtml = '';
        // Stock status badge HTML
        const stockBadgeHtml = isOutOfStock 
          ? '<span class="stock-badge out-of-stock">Out of Stock</span>' 
          : (productStock <= 5 ? `<span class="stock-badge low-stock">Only ${productStock} left</span>` : '');
        
        // Hide cart button completely if out of stock
        const cartButtonHtml = isOutOfStock 
          ? '' // No cart button for out of stock items
          : `<a class="action-quick-view add-to-cart-btn" href="javascript:void(0)" data-product='${JSON.stringify(productData)}'><i class="ion-ios-cart"></i></a>`;
        
        if (containerId === '#products-container-list') {
          // List view
          productHtml = `
            <div class="${colClass}">
              <div class="product-item ${isOutOfStock ? 'out-of-stock-item' : ''}">
                <div class="product-thumb">
                  ${stockBadgeHtml}
                  <img src="${productImage}" alt="${product.name}">
                  <div class="product-action">
                    ${cartButtonHtml}
                    <a class="action-quick-view quick-view-btn" href="javascript:void(0)" data-product='${JSON.stringify(productData)}'><i class="ion-arrow-expand"></i></a>
                    <a class="action-quick-view add-to-wishlist-btn" href="javascript:void(0)" data-product='${JSON.stringify(productData)}'><i class="ion-heart"></i></a>
                  </div>
                </div>
                <div class="product-info">
                  <div class="rating">
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                  </div>
                  <h4 class="title"><a href="shop-single-product.html?id=${product.id}">${product.name}</a></h4>
                  <div class="prices">
                    <span class="price">${formattedPrice}</span>
                  </div>
                  ${product.description ? `<p>${product.description}</p>` : ''}
                  ${!isOutOfStock && productStock > 0 ? `<p class="stock-info"><small>In Stock: ${productStock} available</small></p>` : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          // Grid view
          productHtml = `
            <div class="${colClass}">
              <div class="product-item ${isOutOfStock ? 'out-of-stock-item' : ''}">
                <div class="product-thumb">
                  ${stockBadgeHtml}
                  <img src="${productImage}" alt="${product.name}">
                  <div class="product-action">
                    ${cartButtonHtml}
                    <a class="action-quick-view quick-view-btn" href="javascript:void(0)" data-product='${JSON.stringify(productData)}'><i class="ion-arrow-expand"></i></a>
                    <a class="action-quick-view add-to-wishlist-btn" href="javascript:void(0)" data-product='${JSON.stringify(productData)}'><i class="ion-heart"></i></a>
                  </div>
                </div>
                <div class="product-info">
                  <div class="rating">
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                    <span class="fa fa-star"></span>
                  </div>
                  <h4 class="title"><a href="shop-single-product.html?id=${product.id}">${product.name}</a></h4>
                  <div class="prices">
                    <span class="price">${formattedPrice}</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        container.append(productHtml);
      });
      
      // Attach event handlers
      attachEventHandlers();
    }
    
    // Format price
    function formatPrice(price) {
      if (!price || price === 0) return 'LKR 0.00';
      // Add thousand separators to the price
      return 'LKR ' + parseFloat(price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    // Attach event handlers for cart and wishlist
    function attachEventHandlers() {
      $(document).off('click', '.add-to-cart-btn').on('click', '.add-to-cart-btn', async function(e) {
        e.preventDefault();
        
        // Check if button is disabled
        if ($(this).hasClass('disabled')) {
          showToast('This product is out of stock', 'error');
          return;
        }
        
        const productDataAttr = $(this).attr('data-product');
        if (!productDataAttr) {
          showToast('Product data not found', 'error');
          return;
        }
        
        const productData = JSON.parse(productDataAttr);
        
        // Get quantity from modal input if in modal
        const quantityInput = $('.product-quick-view-modal #modal-quantity');
        if (quantityInput.length > 0) {
          const quantity = parseInt(quantityInput.val()) || 1;
          if (quantity > 0) {
            productData.quantity = quantity;
          }
        }
        
        if (window.CartService) {
          // Use stock-checked add to cart
          const result = await window.CartService.addToCartWithStockCheck(productData);
          
          if (result.success) {
            showToast('Product added to cart!', 'success');
          } else {
            showToast(result.message || 'Failed to add to cart', 'error');
          }
        }
      });
      
      $(document).off('click', '.add-to-wishlist-btn').on('click', '.add-to-wishlist-btn', async function(e) {
        e.preventDefault();
        const $this = $(this);
        let productData;
        
        try {
          const productDataStr = $this.attr('data-product');
          if (!productDataStr) {
            // No product data found
            return;
          }
          productData = JSON.parse(productDataStr);
        } catch (error) {
          // Error parsing product data
          return;
        }
        
        if (productData && typeof window.WishlistService !== 'undefined') {
          // Disable button to prevent multiple clicks
          $this.prop('disabled', true);
          
          try {
            const result = await window.WishlistService.addToWishlist(productData);
            
            if (result.success) {
              showToast(result.message || 'Product added to wishlist!', 'success');
            } else {
              showToast(result.message || 'Failed to add product to wishlist', 'error');
            }
          } catch (error) {
            // Error adding to wishlist
            showToast('An error occurred. Please try again.', 'error');
          } finally {
            // Re-enable button
            $this.prop('disabled', false);
          }
        } else {
          showToast('Wishlist service is not available. Please refresh the page.', 'error');
        }
      });
    }
    
    // Pagination state
    let currentPage = 1;
    const itemsPerPage = 12;
    let allProducts = [];
    let filteredProducts = [];
    let totalProductsCount = 0; // Store total count from API before filtering
    let minPrice = 0;
    let maxPrice = 0;
    let priceRange = { min: 0, max: 0 };
    let stockMap = new Map(); // Map of productId -> availableQuantity
    let stockFilter = { showInStock: true, showOutOfStock: true }; // Stock availability filter
    let currentSortOrder = 'default'; // Current sort order
    
    // Render pagination
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationHtml = `
        <ul class="page-numbers justify-content-end">
          ${currentPage > 1 ? `
            <li>
              <a class="page-number" href="javascript:void(0)" data-page="${currentPage - 1}">
                <i class="fa fa-angle-left"></i>
              </a>
            </li>
          ` : ''}
          ${Array.from({ length: totalPages }, (_, i) => i + 1).map(page => `
            <li>
              <a class="page-number ${page === currentPage ? 'active' : ''}" href="javascript:void(0)" data-page="${page}">${page}</a>
            </li>
          `).join('')}
          ${currentPage < totalPages ? `
            <li>
              <a class="page-number next" href="javascript:void(0)" data-page="${currentPage + 1}">
                <i class="fa fa-angle-right"></i>
              </a>
            </li>
          ` : ''}
        </ul>
      `;
      $('.pagination-area nav').html(paginationHtml);
      
      // Attach pagination click handlers
      $('.page-number').off('click').on('click', function(e) {
        e.preventDefault();
        const page = parseInt($(this).attr('data-page'));
        if (page && page !== currentPage) {
          currentPage = page;
          
          // Update URL without page reload
          const urlParams = new URLSearchParams(window.location.search);
          urlParams.set('page', page);
          const newUrl = window.location.pathname + '?' + urlParams.toString();
          window.history.pushState({ page: page }, '', newUrl);
          
          displayProducts();
        }
      });
    }
    
    // Filter products by price range
    function filterProductsByPrice(products) {
      // If price range is not set (0,0), return all products (no filter active)
      if (priceRange.min === 0 && priceRange.max === 0) {
        return products;
      }
      
      // Filter by price range - products must be within min and max
      return products.filter(product => {
        const productPrice = product.sellingPrice > 0 ? product.sellingPrice : (product.unitPrice > 0 ? product.unitPrice : 0);
        // If product has no price (0), include it
        if (productPrice === 0) {
          return true;
        }
        // Check min price if set
        if (priceRange.min > 0 && productPrice < priceRange.min) {
          return false;
        }
        // Check max price if set (and not the "no limit" value)
        if (priceRange.max > 0 && priceRange.max < 999999999 && productPrice > priceRange.max) {
          return false;
        }
        return true;
      });
    }
    
    // Filter products by stock availability
    function filterProductsByStock(products) {
      // If both are checked (or both unchecked), show all
      if ((stockFilter.showInStock && stockFilter.showOutOfStock) || 
          (!stockFilter.showInStock && !stockFilter.showOutOfStock)) {
        return products;
      }
      
      return products.filter(product => {
        // Try both number and string versions of product ID
        const productId = product.id;
        const productStock = stockMap.get(productId) || stockMap.get(String(productId)) || stockMap.get(Number(productId)) || 0;
        const isOutOfStock = productStock <= 0;
        
        if (stockFilter.showInStock && !stockFilter.showOutOfStock) {
          // Only show in-stock items
          return !isOutOfStock;
        }
        if (stockFilter.showOutOfStock && !stockFilter.showInStock) {
          // Only show out-of-stock items
          return isOutOfStock;
        }
        return true;
      });
    }
    
    // Update stock counts in the availability filter
    function updateStockCounts() {
      let inStockCount = 0;
      let outOfStockCount = 0;
      
      // Count based on current products (after search/category/price filter, but before stock filter)
      const productsToCount = filterProductsByPrice(allProducts);
      
      productsToCount.forEach(product => {
        // Try both number and string versions of product ID
        const productId = product.id;
        let productStock = stockMap.get(productId) || stockMap.get(String(productId)) || stockMap.get(Number(productId)) || 0;
        
        if (productStock > 0) {
          inStockCount++;
        } else {
          outOfStockCount++;
        }
      });
      
      $('#in-stock-count').text(`(${inStockCount})`);
      $('#out-of-stock-count').text(`(${outOfStockCount})`);
    }
    
    // Apply sort order and re-render products (without losing filters)
    function applySortOrder(sortOrder) {
      currentSortOrder = sortOrder;
      
      // Update the sort dropdown label
      const sortLabels = {
        'default': 'Default',
        'popularity': 'Popularity',
        'rated': 'Rated',
        'latest': 'Latest',
        'price-low': 'Price: Low to High',
        'price-high': 'Price: High to Low'
      };
      $('#current-sort-label').html(` ${sortLabels[sortOrder] || 'Default'} <i class="fa fa-angle-down"></i>`);
      
      // Update active state in dropdown
      $('.product-sorting-menu ul li').removeClass('active');
      $(`.product-sorting-menu ul li[data-sort="${sortOrder}"]`).addClass('active');
      
      // Re-display products with the new sort order (this preserves all filters)
      displayProducts(allProducts);
    }
    
    // Sort products by the current sort order
    function sortProductsArray(products) {
      if (!products || products.length === 0) return products;
      
      const sortedProducts = [...products]; // Create a copy to avoid mutating original
      
      switch (currentSortOrder) {
        case 'price-low':
          sortedProducts.sort((a, b) => {
            const priceA = a.sellingPrice || a.unitPrice || 0;
            const priceB = b.sellingPrice || b.unitPrice || 0;
            return priceA - priceB;
          });
          break;
        case 'price-high':
          sortedProducts.sort((a, b) => {
            const priceA = a.sellingPrice || a.unitPrice || 0;
            const priceB = b.sellingPrice || b.unitPrice || 0;
            return priceB - priceA;
          });
          break;
        case 'latest':
          sortedProducts.sort((a, b) => {
            const dateA = new Date(a.createdAt || a.creationTime || 0);
            const dateB = new Date(b.createdAt || b.creationTime || 0);
            return dateB - dateA;
          });
          break;
        case 'rated':
          sortedProducts.sort((a, b) => {
            const ratingA = a.rating || a.averageRating || 0;
            const ratingB = b.rating || b.averageRating || 0;
            return ratingB - ratingA;
          });
          break;
        case 'popularity':
          sortedProducts.sort((a, b) => {
            const popA = a.salesCount || a.orderCount || 0;
            const popB = b.salesCount || b.orderCount || 0;
            return popB - popA;
          });
          break;
        case 'default':
        default:
          // Keep original order (by name or API default)
          break;
      }
      
      return sortedProducts;
    }
    
    // Update category counts based on current filters (without reloading from API)
    function updateCategoryCounts() {
      // Get the currently filtered products (after all filters except category)
      let productsForCounting = allProducts;
      
      // Apply price filter
      productsForCounting = filterProductsByPrice(productsForCounting);
      
      // Apply stock filter
      productsForCounting = filterProductsByStock(productsForCounting);
      
      // Calculate total for "All Categories"
      const totalFilteredCount = productsForCounting.length;
      $('#all-categories-count').text(`(${totalFilteredCount})`);
      
      // Update each category count (skip "all" as it's already updated above)
      $('#product-categories-list li[data-category-id]').each(function() {
        const categoryId = $(this).attr('data-category-id');
        
        // Skip the "all" category
        if (categoryId === 'all') {
          return;
        }
        
        const count = productsForCounting.filter(product => {
          const productCatId = String(product.categoryId || '');
          return productCatId === categoryId;
        }).length;
        
        $(this).find('.category-count').text(`(${count})`);
      });
    }
    
    // Display products for current page
    function displayProducts() {
      // Check if we're in search mode
      const urlParams = new URLSearchParams(window.location.search);
      const searchKeyword = urlParams.get('search') || '';
      
      // Ensure allProducts is available
      if (!allProducts || allProducts.length === 0) {
        // Try to reload products if array is empty
        loadProducts();
        return;
      }
      
      // Apply price filter to all products (including search results)
      let tempFiltered = filterProductsByPrice(allProducts);
      
      // Apply stock filter
      filteredProducts = filterProductsByStock(tempFiltered);
      
      // Apply sort order
      filteredProducts = sortProductsArray(filteredProducts);
      
      // Update stock counts in the sidebar
      updateStockCounts();
      
      // Update category counts based on current filters
      updateCategoryCounts();
      
      // If no filtered products, that's okay - we'll show "No products found" message
      // Don't automatically show all products if filter results are empty
      
      // Ensure currentPage is valid
      if (isNaN(currentPage) || currentPage < 1) {
        currentPage = 1;
      }
      
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);
      
      // Render in all three containers
      renderProducts(productsToShow, '#products-container');
      renderProducts(productsToShow, '#products-container-list');
      renderProducts(productsToShow, '#products-container-two');
      
      // Render pagination
      renderPagination(filteredProducts.length);
      
      // Update product count
      updateProductCount();
      
      // Update active filters display
      updateActiveFiltersDisplay();
      
      // Update category counts to reflect current filters
      loadProductCategories();
    }
    
    // Update active filters display
    function updateActiveFiltersDisplay() {
      const activeFiltersContainer = $('#active-filters-display');
      const activeFiltersList = $('#active-filters-list');
      
      if (!activeFiltersContainer.length || !activeFiltersList.length) {
        return;
      }
      
      activeFiltersList.empty();
      let hasFilters = false;
      let filterCount = 0;
      
      // Check for active search
      const urlParams = new URLSearchParams(window.location.search);
      const searchKeyword = urlParams.get('search') || '';
      if (searchKeyword && searchKeyword.trim() !== '') {
        activeFiltersList.append(`
          <span class="active-filter-badge" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background-color: #fff; border: 1px solid #f379a7; border-radius: 12px; font-size: 12px;">
            <span>Search: "${searchKeyword}"</span>
            <button type="button" class="clear-filter-btn" data-filter="search" style="background: none; border: none; color: #f379a7; cursor: pointer; font-size: 14px; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
          </span>
        `);
        hasFilters = true;
        filterCount++;
      }
      
      // Check for active category
      const categoryId = urlParams.get('category');
      if (categoryId) {
        // Find category name
        const categoryName = $('#product-categories-list li a.active').text().replace(/\s*\(\d+\)$/, '') || 'Category';
        activeFiltersList.append(`
          <span class="active-filter-badge" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background-color: #fff; border: 1px solid #2196F3; border-radius: 12px; font-size: 12px;">
            <span>Category: ${categoryName}</span>
            <button type="button" class="clear-filter-btn" data-filter="category" style="background: none; border: none; color: #2196F3; cursor: pointer; font-size: 14px; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
          </span>
        `);
        hasFilters = true;
        filterCount++;
      }
      
      // Check for active price filter (only if user has set values)
      const hasPriceFilter = (priceRange.min > 0 || (priceRange.max > 0 && priceRange.max < 999999999));
      
      if (hasPriceFilter) {
        // Build price label based on what's set
        let priceLabel = 'Price: ';
        if (priceRange.min > 0 && priceRange.max > 0 && priceRange.max < 999999999) {
          priceLabel += formatPrice(priceRange.min) + ' - ' + formatPrice(priceRange.max);
        } else if (priceRange.min > 0) {
          priceLabel += 'Min ' + formatPrice(priceRange.min);
        } else if (priceRange.max > 0 && priceRange.max < 999999999) {
          priceLabel += 'Max ' + formatPrice(priceRange.max);
        }
        
        activeFiltersList.append(`
          <span class="active-filter-badge" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background-color: #fff; border: 1px solid #4CAF50; border-radius: 12px; font-size: 12px;">
            <span>${priceLabel}</span>
            <button type="button" class="clear-filter-btn" data-filter="price" style="background: none; border: none; color: #4CAF50; cursor: pointer; font-size: 14px; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
          </span>
        `);
        hasFilters = true;
        filterCount++;
      }
      
      // Check for active stock filter (when not showing all)
      const hasStockFilter = !(stockFilter.showInStock && stockFilter.showOutOfStock);
      
      if (hasStockFilter) {
        let stockLabel = 'Stock: ';
        if (stockFilter.showInStock && !stockFilter.showOutOfStock) {
          stockLabel += 'In Stock Only';
        } else if (!stockFilter.showInStock && stockFilter.showOutOfStock) {
          stockLabel += 'Out of Stock Only';
        } else {
          stockLabel += 'None Selected';
        }
        
        activeFiltersList.append(`
          <span class="active-filter-badge" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background-color: #fff; border: 1px solid #FF9800; border-radius: 12px; font-size: 12px;">
            <span>${stockLabel}</span>
            <button type="button" class="clear-filter-btn" data-filter="stock" style="background: none; border: none; color: #FF9800; cursor: pointer; font-size: 14px; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
          </span>
        `);
        hasFilters = true;
        filterCount++;
      }
      
      // Add "Clear All" button if more than one filter is active
      if (filterCount > 1) {
        activeFiltersList.append(`
          <button type="button" class="clear-all-filters-btn" style="background: #dc3545; border: none; color: #fff; cursor: pointer; font-size: 12px; padding: 4px 10px; border-radius: 12px; margin-left: 5px;">Clear All</button>
        `);
      }
      
      // Show/hide active filters container
      if (hasFilters) {
        activeFiltersContainer.show();
      } else {
        activeFiltersContainer.hide();
      }
      
      // Handle clear filter buttons
      $('.clear-filter-btn').off('click').on('click', function() {
        const filterType = $(this).data('filter');
        
        if (filterType === 'search') {
          // Remove search from URL
          const urlParams = new URLSearchParams(window.location.search);
          urlParams.delete('search');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.pushState({}, '', newUrl);
          // Clear search inputs
          $('#search').val('');
          $('#search-input').val('');
          $('#search-results-message').hide();
          currentPage = 1;
          loadProducts();
        } else if (filterType === 'category') {
          // Remove category from URL
          const urlParams = new URLSearchParams(window.location.search);
          urlParams.delete('category');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.pushState({}, '', newUrl);
          currentPage = 1;
          loadProducts();
        } else if (filterType === 'price') {
          // Clear price filter
          resetPriceFilter();
        } else if (filterType === 'stock') {
          // Clear stock filter
          resetStockFilter();
        }
      });
      
      // Handle clear all filters button
      $('.clear-all-filters-btn').off('click').on('click', function() {
        // Clear all filters
        const newUrl = window.location.pathname;
        window.history.pushState({}, '', newUrl);
        // Clear search inputs
        $('#search').val('');
        $('#search-input').val('');
        $('#search-results-message').hide();
        // Clear price filter
        const minInput = $('#price-min-input');
        const maxInput = $('#price-max-input');
        minInput.val('');
        maxInput.val('');
        priceRange.min = 0;
        priceRange.max = 0;
        // Clear stock filter
        stockFilter.showInStock = true;
        stockFilter.showOutOfStock = true;
        $('#show-in-stock').prop('checked', true);
        $('#show-out-of-stock').prop('checked', true);
        currentPage = 1;
        loadProducts();
      });
    }
    
    // Update product count display
    function updateProductCount() {
      // Use filteredProducts.length for accurate display after all filters applied
      const filteredTotal = filteredProducts.length;
      const start = filteredTotal > 0 ? Math.min((currentPage - 1) * itemsPerPage + 1, filteredTotal) : 0;
      const end = Math.min(currentPage * itemsPerPage, filteredTotal);
      
      // Check if any filters are active
      const urlParams = new URLSearchParams(window.location.search);
      const hasSearch = urlParams.get('search') && urlParams.get('search').trim() !== '';
      const hasCategory = urlParams.get('category');
      const hasPriceFilter = (priceRange.min > 0 || (priceRange.max > 0 && priceRange.max < 999999999));
      const hasAnyFilter = hasSearch || hasCategory || hasPriceFilter;
      
      if (filteredTotal > 0) {
        if (hasAnyFilter) {
          // Show filtered count when filters are active
          $('.count-result').html(`<span>${start}-${end}</span> of <span>${filteredTotal}</span> Products (filtered)`);
        } else {
          // Show total count when no filters
          $('.count-result').html(`<span>${start}-${end}</span> of <span>${filteredTotal}</span> Products`);
        }
      } else {
        if (hasAnyFilter) {
          $('.count-result').html(`<span>0</span> Products Found (no matches for current filters)`);
        } else {
          $('.count-result').html(`<span>0</span> Products Found`);
        }
      }
    }
    
    // Load products
    async function loadProducts() {
      try {
        // Get category and page from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get('category');
        const searchKeyword = urlParams.get('search') || '';
        const pageParam = urlParams.get('page');
        currentPage = pageParam ? parseInt(pageParam) : 1;
        
        // Ensure currentPage is valid
        if (isNaN(currentPage) || currentPage < 1) {
          currentPage = 1;
        }
        
        // Ensure search keyword is preserved in URL if it exists
        if (searchKeyword && !window.location.search.includes('search=')) {
          urlParams.set('search', searchKeyword);
          const newUrl = window.location.pathname + '?' + urlParams.toString();
          window.history.replaceState({}, '', newUrl);
        }
        
        // Search results message will be handled in document.ready
        
        // Show loading state only if containers exist
        const containers = ['#products-container', '#products-container-list', '#products-container-two'];
        containers.forEach(containerId => {
          const container = $(containerId);
          if (container && container.length) {
            container.html('<div class="col-12"><p class="text-center">Loading products...</p></div>');
          }
        });
        
        // Fetch products with search keyword (API should filter by keyword)
        // Fetch more products to get accurate counts - use 1000 to get all products for counting
        const result = await window.fetchProducts(0, 1000, categoryId, searchKeyword);
        
        // Fetch stock levels in parallel
        try {
          if (typeof window.getStockMap === 'function') {
            stockMap = await window.getStockMap();
          }
        } catch (stockError) {
          // Failed to fetch stock levels, continue without stock info
          stockMap = new Map();
        }
        
        // Store total count from API before filtering
        totalProductsCount = (result && result.totalCount) ? result.totalCount : 0;
        
        if (result && result.items && result.items.length > 0) {
          let productsToShow = result.items;
          
          // If searching, don't filter by category (let API handle it)
          // Only filter by category if NOT searching
          if (categoryId && !searchKeyword) {
            productsToShow = result.items.filter(product => {
              const productCatId = String(product.categoryId || '');
              const filterCatId = String(categoryId || '');
              return productCatId === filterCatId;
            });
            // Update total count to reflect filtered category products
            totalProductsCount = productsToShow.length;
          }
          
          // Use all products (no image filter - will use default image if needed)
          let productsToDisplay = productsToShow;
          
          // If searching and no results, show message
          if (searchKeyword && productsToDisplay.length === 0) {
            $('#products-container').html('<div class="col-12"><p class="text-center">No products found for "' + searchKeyword + '".</p></div>');
            $('#products-container-list').html('<div class="col-12"><p class="text-center">No products found for "' + searchKeyword + '".</p></div>');
            $('#products-container-two').html('<div class="col-12"><p class="text-center">No products found for "' + searchKeyword + '".</p></div>');
            $('.pagination-area nav').html('');
            return;
          }
          
          // Sort products - prioritize search relevance if searching
          if (searchKeyword && searchKeyword.trim() !== '') {
            const searchTerm = searchKeyword.toLowerCase().trim();
            productsToDisplay.sort((a, b) => {
              const nameA = (a.name || '').toLowerCase();
              const nameB = (b.name || '').toLowerCase();
              const descriptionA = (a.description || '').toLowerCase();
              const descriptionB = (b.description || '').toLowerCase();
              
              // Calculate relevance score
              let scoreA = 0;
              let scoreB = 0;
              
              // Exact name match gets highest priority
              if (nameA === searchTerm) scoreA += 1000;
              if (nameB === searchTerm) scoreB += 1000;
              
              // Name starts with search term
              if (nameA.startsWith(searchTerm)) scoreA += 500;
              if (nameB.startsWith(searchTerm)) scoreB += 500;
              
              // Name contains search term
              if (nameA.includes(searchTerm)) scoreA += 100;
              if (nameB.includes(searchTerm)) scoreB += 100;
              
              // Description contains search term
              if (descriptionA.includes(searchTerm)) scoreA += 50;
              if (descriptionB.includes(searchTerm)) scoreB += 50;
              
              // If same relevance, sort by date (newest first)
              if (scoreA === scoreB) {
                const dateA = new Date(a.creationTime || a.lastModificationTime || 0);
                const dateB = new Date(b.creationTime || b.lastModificationTime || 0);
                return dateB - dateA;
              }
              
              // Sort by relevance score (highest first)
              return scoreB - scoreA;
            });
          } else {
            // Sort by creation date descending when not searching
            productsToDisplay.sort((a, b) => {
              const dateA = new Date(a.creationTime || a.lastModificationTime || 0);
              const dateB = new Date(b.creationTime || b.lastModificationTime || 0);
              return dateB - dateA;
            });
          }
          
          // Store all products
          allProducts = productsToDisplay;
          
          // Calculate min and max prices
          // Min is always LKR 100
          minPrice = 100;
          
          if (allProducts.length > 0) {
            const prices = allProducts.map(product => {
              return product.sellingPrice > 0 ? product.sellingPrice : (product.unitPrice > 0 ? product.unitPrice : 0);
            }).filter(price => price > 0); // Exclude zero prices from min/max calculation
            
            if (prices.length > 0) {
              // Get the maximum price from products
              const calculatedMaxPrice = Math.ceil(Math.max(...prices));
              
              // Max defaults to LKR 1000, but if products have prices > 1000, use the highest price
              maxPrice = Math.max(1000, calculatedMaxPrice);
            } else {
              // No valid prices found, use default max
              maxPrice = 1000;
            }
          } else {
            // No products, use default max
            maxPrice = 1000;
          }
            
            // Initialize price filter event handlers (only once)
            if (!window.priceSliderInitialized) {
              initializePriceFilter();
              initializeStockFilter();
              window.priceSliderInitialized = true;
            }
            // Note: priceRange stays at 0,0 (no filter) until user explicitly applies a filter
          
          // Display products for current page (this will show search results)
          displayProducts();
          
          // Ensure search parameter stays in URL and prevent any reloads
          if (searchKeyword && searchKeyword.trim() !== '') {
            const currentUrlParams = new URLSearchParams(window.location.search);
            const currentSearch = currentUrlParams.get('search');
            if (!currentSearch || currentSearch !== searchKeyword) {
              currentUrlParams.set('search', searchKeyword);
              const newUrl = window.location.pathname + '?' + currentUrlParams.toString();
              // Use replaceState to avoid triggering page reload
              window.history.replaceState({ search: searchKeyword }, '', newUrl);
            }
            // Ensure search inputs are populated
            setTimeout(function() {
              $('#search').val(searchKeyword);
              $('#search-input').val(searchKeyword);
              $('#search-results-message').show();
              $('#search-term-display').text(searchKeyword);
            }, 100);
          }
        } else {
          // No products found - show message but preserve search parameter
          const noResultsMessage = searchKeyword 
            ? `No products found for "${searchKeyword}".` 
            : 'No products found.';
          $('#products-container').html('<div class="col-12"><p class="text-center">' + noResultsMessage + '</p></div>');
          $('#products-container-list').html('<div class="col-12"><p class="text-center">' + noResultsMessage + '</p></div>');
          $('#products-container-two').html('<div class="col-12"><p class="text-center">' + noResultsMessage + '</p></div>');
          $('.pagination-area nav').html('');
          
          // Ensure search parameter stays in URL even when no results
          if (searchKeyword && searchKeyword.trim() !== '') {
            const currentUrlParams = new URLSearchParams(window.location.search);
            if (!currentUrlParams.get('search') || currentUrlParams.get('search') !== searchKeyword) {
              currentUrlParams.set('search', searchKeyword);
              const newUrl = window.location.pathname + '?' + currentUrlParams.toString();
              window.history.replaceState({}, '', newUrl);
            }
          }
        }
      } catch (error) {
        // Error loading products
        const errorMessage = '<div class="col-12"><p class="text-center">Error loading products. Please try again later.</p></div>';
        const containers = ['#products-container', '#products-container-list', '#products-container-two'];
        containers.forEach(containerId => {
          const container = $(containerId);
          if (container && container.length) {
            container.html(errorMessage);
          }
        });
        const paginationNav = $('.pagination-area nav');
        if (paginationNav && paginationNav.length) {
          paginationNav.html('');
        }
      }
    }
    
    async function loadProductCategories() {
      try {
        // Check if categories container exists
        const categoriesContainer = $('#product-categories-list');
        if (!categoriesContainer || !categoriesContainer.length) {
          setTimeout(function() {
            loadProductCategories();
          }, 300);
          return;
        }
        
        const categories = await window.fetchCategories();
        
        if (categories && categories.length > 0) {
          // Fetch all products to calculate accurate category counts
          try {
            const allProductsResult = await window.fetchProducts(0, 1000, null, '');
            if (allProductsResult && allProductsResult.items) {
              // Get current filters
              const urlParams = new URLSearchParams(window.location.search);
              const searchKeyword = urlParams.get('search') || '';
              
              // Filter products based on current search and price filter
              let productsForCounting = allProductsResult.items;
              
              // Apply search filter if active
              if (searchKeyword && searchKeyword.trim() !== '') {
                const searchTerm = searchKeyword.toLowerCase().trim();
                productsForCounting = productsForCounting.filter(product => {
                  const name = (product.name || '').toLowerCase();
                  const description = (product.description || '').toLowerCase();
                  const code = (product.code || '').toLowerCase();
                  return name.includes(searchTerm) || description.includes(searchTerm) || code.includes(searchTerm);
                });
              }
              
              // Apply price filter if active (only if user has set values)
              const hasPriceFilter = (priceRange.min > 0 || (priceRange.max > 0 && priceRange.max < 999999999));
              
              if (hasPriceFilter) {
                productsForCounting = productsForCounting.filter(product => {
                  const productPrice = product.sellingPrice > 0 ? product.sellingPrice : (product.unitPrice > 0 ? product.unitPrice : 0);
                  if (productPrice === 0) return true;
                  if (priceRange.min > 0 && productPrice < priceRange.min) return false;
                  if (priceRange.max > 0 && priceRange.max < 999999999 && productPrice > priceRange.max) return false;
                  return true;
                });
              }
              
              // Apply stock filter if active
              const hasStockFilter = !(stockFilter.showInStock && stockFilter.showOutOfStock);
              if (hasStockFilter) {
                productsForCounting = productsForCounting.filter(product => {
                  const productStock = stockMap.get(product.id) || stockMap.get(String(product.id)) || stockMap.get(Number(product.id)) || 0;
                  const isOutOfStock = productStock <= 0;
                  
                  if (stockFilter.showInStock && !stockFilter.showOutOfStock) {
                    return !isOutOfStock;
                  }
                  if (stockFilter.showOutOfStock && !stockFilter.showInStock) {
                    return isOutOfStock;
                  }
                  return true;
                });
              }
              
              // Calculate product count for each category based on filtered products
              categories.forEach(category => {
                const categoryId = String(category.id || '');
                category.productCount = productsForCounting.filter(product => {
                  const productCatId = String(product.categoryId || '');
                  return productCatId === categoryId;
                }).length;
              });
            }
          } catch (error) {
            // Continue with API-provided counts or 0
          }
          
          renderCategories(categories);
        } else {
          categoriesContainer.html('<li>No categories found</li>');
        }
      } catch (error) {
        // Error loading categories
        const categoriesContainer = $('#product-categories-list');
        if (categoriesContainer && categoriesContainer.length) {
          categoriesContainer.html('<li>Error loading categories</li>');
        }
      }
    }
    
    // Reset ALL filters function (globally accessible)
    function resetPriceFilter() {
      // Reset price filter
      const minInput = $('#price-min-input');
      const maxInput = $('#price-max-input');
      minInput.val('');
      maxInput.val('');
      priceRange.min = 0;
      priceRange.max = 0;
      
      // Reset stock filter
      stockFilter.showInStock = true;
      stockFilter.showOutOfStock = true;
      $('#show-in-stock').prop('checked', true);
      $('#show-out-of-stock').prop('checked', true);
      
      // Reset sort order
      currentSortOrder = 'default';
      $('#current-sort-label').html(' Default <i class="fa fa-angle-down"></i>');
      $('.product-sorting-menu ul li').removeClass('active');
      $('.product-sorting-menu ul li[data-sort="default"]').addClass('active');
      
      // Update category UI - deselect all, select "All"
      $('#product-categories-list li').removeClass('active');
      $('#product-categories-list li a').css('color', '');
      $('#product-categories-list li:first-child').addClass('active');
      $('#product-categories-list li:first-child a').css('color', '#f379a7');
      
      // Reset page
      currentPage = 1;
      
      // Clear URL parameters and redirect to clean shop page
      window.location.href = window.location.pathname;
    }
    
    // Make resetPriceFilter available globally
    window.resetPriceFilter = resetPriceFilter;
    
    // Make applySortOrder available globally
    window.applySortOrder = applySortOrder;
    
    // Initialize price filter input fields
    function initializePriceFilter() {
      const minInput = $('#price-min-input');
      const maxInput = $('#price-max-input');
      
      if (!minInput.length || !maxInput.length) {
        return;
      }
      
      // Leave input fields empty - no default values
      // Price filter only applies when user explicitly sets values
      minInput.val('');
      maxInput.val('');
      
      // Set price range to 0 (no filter active)
      priceRange.min = 0;
      priceRange.max = 0;
      
      // Use event delegation for button clicks (works even if bound multiple times)
      $(document).off('click', '#apply-price-filter').on('click', '#apply-price-filter', function() {
        applyPriceFilter();
      });
      
      $(document).off('click', '#reset-price-filter').on('click', '#reset-price-filter', function() {
        resetPriceFilter();
      });
      
      // Handle Enter key on input fields using event delegation
      $(document).off('keypress', '#price-min-input').on('keypress', '#price-min-input', function(e) {
        if (e.which === 13) { // Enter key
          e.preventDefault();
          applyPriceFilter();
        }
      });
      
      $(document).off('keypress', '#price-max-input').on('keypress', '#price-max-input', function(e) {
        if (e.which === 13) { // Enter key
          e.preventDefault();
          applyPriceFilter();
        }
      });
    }
    
    // Initialize stock filter checkboxes
    function initializeStockFilter() {
      // Read initial state from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const stockParam = urlParams.get('stock');
      
      if (stockParam === 'in-stock') {
        stockFilter.showInStock = true;
        stockFilter.showOutOfStock = false;
        $('#show-in-stock').prop('checked', true);
        $('#show-out-of-stock').prop('checked', false);
      } else if (stockParam === 'out-of-stock') {
        stockFilter.showInStock = false;
        stockFilter.showOutOfStock = true;
        $('#show-in-stock').prop('checked', false);
        $('#show-out-of-stock').prop('checked', true);
      } else {
        // Default: show all
        stockFilter.showInStock = true;
        stockFilter.showOutOfStock = true;
        $('#show-in-stock').prop('checked', true);
        $('#show-out-of-stock').prop('checked', true);
      }
      
      // Handle checkbox changes using event delegation
      $(document).off('change', '#show-in-stock').on('change', '#show-in-stock', function() {
        stockFilter.showInStock = $(this).is(':checked');
        updateStockFilterUrl();
        currentPage = 1;
        displayProducts();
        updateActiveFiltersDisplay();
      });
      
      $(document).off('change', '#show-out-of-stock').on('change', '#show-out-of-stock', function() {
        stockFilter.showOutOfStock = $(this).is(':checked');
        updateStockFilterUrl();
        currentPage = 1;
        displayProducts();
        updateActiveFiltersDisplay();
      });
    }
    
    // Update URL with stock filter parameter
    function updateStockFilterUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      
      if (stockFilter.showInStock && !stockFilter.showOutOfStock) {
        urlParams.set('stock', 'in-stock');
      } else if (!stockFilter.showInStock && stockFilter.showOutOfStock) {
        urlParams.set('stock', 'out-of-stock');
      } else {
        // Both or neither - remove stock param
        urlParams.delete('stock');
      }
      
      const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
      window.history.pushState({}, '', newUrl);
    }
    
    // Reset stock filter
    function resetStockFilter() {
      stockFilter.showInStock = true;
      stockFilter.showOutOfStock = true;
      $('#show-in-stock').prop('checked', true);
      $('#show-out-of-stock').prop('checked', true);
      updateStockFilterUrl();
      currentPage = 1;
      displayProducts();
      updateActiveFiltersDisplay();
    }
    
    // Make resetStockFilter available globally
    window.resetStockFilter = resetStockFilter;
    
    // Apply price filter from input fields
    function applyPriceFilter() {
      const minInput = $('#price-min-input');
      const maxInput = $('#price-max-input');
      
      // Get values from inputs
      let minVal = parseFloat(minInput.val());
      let maxVal = parseFloat(maxInput.val());
      
      // If both are empty, clear the filter
      if (isNaN(minVal) && isNaN(maxVal)) {
        priceRange.min = 0;
        priceRange.max = 0;
        currentPage = 1;
        displayProducts();
        return;
      }
      
      // If min is empty, use 0
      if (isNaN(minVal) || minVal < 0) {
        minVal = 0;
      }
      
      // If max is empty, use a very high value (no upper limit)
      if (isNaN(maxVal) || maxVal <= 0) {
        maxVal = 999999999;
      }
      
      // Ensure max is greater than min
      if (maxVal < minVal) {
        maxVal = minVal;
        maxInput.val(maxVal);
      }
      
      // Update price range for filtering
      priceRange.min = minVal;
      priceRange.max = maxVal;
      
      // Reset to first page and filter products
      currentPage = 1;
      displayProducts();
    }
    
    // Render categories with product counts
    function renderCategories(categories) {
      const categoriesList = $('#product-categories-list');
      if (!categoriesList || !categoriesList.length) {
        return;
      }
      
      categoriesList.empty();
      
      // Get current category and search from URL
      const urlParams = new URLSearchParams(window.location.search);
      const currentCategoryId = urlParams.get('category');
      const searchKeyword = urlParams.get('search') || '';
      
      // Calculate total product count for "All Categories"
      const totalProductCount = categories.reduce((sum, cat) => sum + (cat.productCount || 0), 0);
      
      // Add "All Categories" option first
      const allCategoriesParams = new URLSearchParams();
      if (searchKeyword) {
        allCategoriesParams.set('search', searchKeyword);
      }
      const allCategoriesLink = `shop${allCategoriesParams.toString() ? '?' + allCategoriesParams.toString() : ''}`;
      const allCategoriesActive = !currentCategoryId ? 'active' : '';
      const allCategoriesItem = $(`
        <li data-category-id="all"><a href="${allCategoriesLink}" class="${allCategoriesActive}" style="font-weight: ${!currentCategoryId ? '600' : '500'};">All Categories <span id="all-categories-count" class="category-count">(${totalProductCount})</span></a></li>
      `);
      
      allCategoriesItem.find('a').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const urlToNavigate = $(this).attr('href');
        window.history.pushState({}, '', urlToNavigate);
        currentPage = 1;
        loadProducts();
        
        $('#product-categories-list li a').removeClass('active');
        $(this).addClass('active');
        return false;
      });
      
      categoriesList.append(allCategoriesItem);
      
      categories.forEach(category => {
        // Preserve search parameter when clicking categories
        const newParams = new URLSearchParams();
        if (category.id) {
          newParams.set('category', category.id);
        }
        if (searchKeyword) {
          newParams.set('search', searchKeyword);
        }
        const queryString = newParams.toString();
        const categoryLink = `shop${queryString ? '?' + queryString : ''}`;
        const isActive = currentCategoryId && String(category.id) === String(currentCategoryId);
        const activeClass = isActive ? 'active' : '';
        const listItem = $(`
          <li data-category-id="${category.id}"><a href="${categoryLink}" class="${activeClass}">${category.name} <span class="category-count">(${category.productCount || 0})</span></a></li>
        `);
        
        // Prevent default navigation and handle with JavaScript to avoid scroll to top
        listItem.find('a').on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Update URL without page reload
          const urlToNavigate = $(this).attr('href');
          if (urlToNavigate) {
            // Parse the URL to get query parameters
            const url = new URL(urlToNavigate, window.location.origin);
            const categoryId = url.searchParams.get('category');
            const searchKeyword = url.searchParams.get('search') || '';
            
            // Update URL without reloading page
            window.history.pushState({ category: categoryId }, '', urlToNavigate);
            
            // Reset to first page
            currentPage = 1;
            
            // Load products with new category
            loadProducts();
            
            // Update active category styling
            $('#product-categories-list li a').removeClass('active');
            $(this).addClass('active');
          }
          
          // Prevent scroll to top by returning false
          return false;
        });
        
        categoriesList.append(listItem);
      });
    }
    
    // Clear search function
    function clearSearch() {
      // Clear search inputs
      $('#search').val('');
      $('#search-input').val('');
      // Reload page without search parameter
      window.location.href = 'shop';
    }
    
    // Make clearSearch available globally
    window.clearSearch = clearSearch;
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
      // When user uses browser back/forward, reload products based on current URL
      currentPage = 1;
      loadProducts();
    });
    
    // Initialize on page load
    $(document).ready(function() {
      // Always initialize - load categories first, then products
      // Categories don't depend on product containers
      initializePage();
    });
    
    // Separate initialization function for better error handling
    function initializePage() {
      // Populate search inputs when page loads
      const urlParams = new URLSearchParams(window.location.search);
      const searchKeyword = urlParams.get('search') || '';
      
      if (searchKeyword) {
        // Keep search term visible in inputs
        $('#search').val(searchKeyword);
        $('#search-input').val(searchKeyword);
        // Show search results message
        $('#search-results-message').show();
        $('#search-term-display').text(searchKeyword);
      } else {
        // Clear search inputs and hide message when no search
        $('#search').val('');
        $('#search-input').val('');
        $('#search-results-message').hide();
      }
      
      // Clear price filter inputs on page load (no default values)
      $('#price-min-input').val('');
      $('#price-max-input').val('');
      priceRange.min = 0;
      priceRange.max = 0;
      
      // Prevent default price slider initialization from rangeSlider.js
      // We'll initialize it after products are loaded with correct min/max values
      const originalSliderInit = window.noUiSlider;
      if (originalSliderInit) {
        // Store reference but don't auto-initialize
        window.noUiSlider = originalSliderInit;
      }
      
      // Reset state to ensure clean initialization
      allProducts = [];
      filteredProducts = [];
      currentPage = 1;
      
      // Load categories first (they don't depend on product containers)
      loadProductCategories().catch(function(error) {
        // Error loading categories
      });
      
      // Check if product containers exist before loading products
      const productContainers = ['#products-container', '#products-container-list', '#products-container-two'];
      const productContainersExist = productContainers.every(id => $(id).length > 0);
      
      if (productContainersExist) {
        // Load products if containers are ready
        loadProducts().catch(function(error) {
              // Error in loadProducts
        });
      } else {
        // Retry loading products after a short delay if containers aren't ready
        setTimeout(function() {
          if (productContainers.every(id => $(id).length > 0)) {
            loadProducts().catch(function(error) {
              // Error in loadProducts after retry
            });
          } else {
            // Still try to load products - displayProducts will handle empty containers
            loadProducts().catch(function(error) {
              // Error in loadProducts (final attempt)
            });
          }
        }, 500);
      }
      
      // Update cart count
      if (typeof window.CartService !== 'undefined') {
        window.CartService.updateCartCount();
      }

      // Function to show quick view modal with product data
      function showQuickViewModal(product) {
        const productName = product.name || 'Product Name';
        
        // Get price - handle null, undefined, and 0 values properly
        let productPrice = 0;
        
        // Check sellingPrice first
        if (product.sellingPrice !== null && product.sellingPrice !== undefined) {
          if (product.sellingPrice > 0) {
            productPrice = product.sellingPrice;
          } else if (product.unitPrice !== null && product.unitPrice !== undefined && product.unitPrice > 0) {
            productPrice = product.unitPrice;
          } else {
            productPrice = product.sellingPrice; // Use even if 0
          }
        } 
        // If no sellingPrice, check unitPrice
        else if (product.unitPrice !== null && product.unitPrice !== undefined) {
          productPrice = product.unitPrice;
        }
        
        const productDescription = product.description || 'No description available.';
        // Use formatPrice function with thousand separators
        const formattedPrice = window.formatPrice ? window.formatPrice(productPrice) : (productPrice > 0 ? 'LKR ' + parseFloat(productPrice).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'Price not available');
        
        // Handle images - use images array if available, otherwise fallback to imageUrl/imageURL
        let productImages = [];
        let mainImage = 'https://www.holoimage.net/images/no-image.jpg';
        
        if (product.images && Array.isArray(product.images) && product.images.length > 0) {
          // Use images array - first image as main, all as thumbnails
          productImages = product.images.map(img => img.imageUrl || img.imageURL).filter(url => url);
          if (productImages.length > 0) {
            mainImage = productImages[0];
          }
        } else if (product.imageUrls && Array.isArray(product.imageUrls) && product.imageUrls.length > 0) {
          // Fallback to imageUrls array
          productImages = product.imageUrls.filter(url => url);
          if (productImages.length > 0) {
            mainImage = productImages[0];
          }
        } else {
          // Fallback to single imageUrl/imageURL
          const singleImage = product.imageUrl || product.imageURL;
          if (singleImage) {
            mainImage = singleImage;
            productImages = [singleImage];
          }
        }
        
        // Update modal main image
        $('#quick-view-main-image').attr('src', mainImage).attr('alt', productName);
        
        // Update thumbnails
        const thumbnailsContainer = $('#quick-view-thumbnails');
        thumbnailsContainer.empty();
        
        // Show thumbnails if there are multiple images
        if (productImages.length > 1) {
          thumbnailsContainer.show(); // Ensure container is visible
          productImages.forEach((imageUrl, index) => {
            const isActive = index === 0 ? 'active' : '';
            const thumbnailHtml = `
              <div class="thumbnail-item ${isActive}" data-image-index="${index}">
                <img src="${imageUrl}" alt="${productName} - Image ${index + 1}">
              </div>
            `;
            thumbnailsContainer.append(thumbnailHtml);
          });
          
          // Add click handlers for thumbnails
          thumbnailsContainer.off('click', '.thumbnail-item').on('click', '.thumbnail-item', function() {
            const $this = $(this);
            const imageUrl = $this.find('img').attr('src');
            
            // Update main image
            $('#quick-view-main-image').attr('src', imageUrl);
            
            // Update active state
            thumbnailsContainer.find('.thumbnail-item').removeClass('active');
            $this.addClass('active');
          });
        } else {
          // Hide thumbnails container if only one image
          thumbnailsContainer.hide();
        }
        
        // Get stock level for this product (try both number and string keys)
        const productStock = product.maxStock !== undefined ? product.maxStock : (stockMap.get(product.id) || stockMap.get(String(product.id)) || stockMap.get(Number(product.id)) || 0);
        const isOutOfStock = productStock <= 0;
        
        // Stock info HTML
        let stockInfoHtml = '';
        if (isOutOfStock) {
          stockInfoHtml = '<div class="modal-stock-info out-of-stock"><i class="ion-close-circled"></i> Out of Stock</div>';
        } else if (productStock <= 5) {
          stockInfoHtml = `<div class="modal-stock-info low-stock"><i class="ion-alert-circled"></i> Only ${productStock} left in stock - order soon!</div>`;
        } else {
          stockInfoHtml = `<div class="modal-stock-info in-stock"><i class="ion-checkmark-circled"></i> In Stock (${productStock} available)</div>`;
        }
        
        // Update product with maxStock for cart
        product.maxStock = productStock;
        
        // Update modal content
        const modalContent = `
          <div class="single-product-info">
            <h4 class="title">${productName}</h4>
            <div class="prices">
              <span class="price">${formattedPrice}</span>
            </div>
            <div class="product-rating">
              <div class="rating">
                <span class="fa fa-star"></span>
                <span class="fa fa-star"></span>
                <span class="fa fa-star"></span>
                <span class="fa fa-star"></span>
                <span class="fa fa-star"></span>
              </div>
            </div>
            ${stockInfoHtml}
            <p class="product-desc">${productDescription}</p>
            <div class="quick-product-action">
              <div class="action-top">
                ${isOutOfStock ? '' : `
                <div class="pro-qty">
                  <input type="text" id="modal-quantity" title="Quantity" value="1" min="1" max="${productStock}" data-max-stock="${productStock}" />
                </div>
                <button class="btn btn-theme add-to-cart-btn" data-product='${JSON.stringify(product)}'>Add to Cart</button>
                `}
                <a class="btn-wishlist add-to-wishlist-btn" href="javascript:void(0)" data-product='${JSON.stringify(product)}'>Add to Wishlist</a>
              </div>
            </div>
          </div>
        `;
        
        $('#quick-view-content').html(modalContent);
        
        // Initialize quantity buttons for the modal
        const modalProQty = $('#quick-view-content .pro-qty');
        if (modalProQty.length > 0 && modalProQty.find('.qty-btn').length === 0) {
          modalProQty.append('<a href="#" class="inc qty-btn"><i class="fa fa-plus"></i></a>');
          modalProQty.append('<a href="#" class="dec qty-btn"><i class="fa fa-minus"></i></a>');
        }
        
        // Prevent any scroll behavior - just lock the scroll
        const scrollPosition = window.pageYOffset || window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
        
        // Store scroll position
        $('html, body').data('scroll-position', scrollPosition);
        
        // Lock scroll by adding fix class to both html and body
        $('html, body').addClass('fix');
        
        // Show modal
        $('.product-quick-view-modal').addClass('active');
      }

      // Handle quick view modal - use event delegation for dynamically created elements
      $(document).on('click', '.quick-view-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const productDataStr = $(this).attr('data-product');
        if (!productDataStr) return;
        
        try {
          const product = JSON.parse(productDataStr);
          
          // Always try to get the full product data (including images) from the product list
          // Try to find the full product from allProducts array
          if (typeof allProducts !== 'undefined' && allProducts.length > 0) {
            const fullProduct = allProducts.find(p => p.id === product.id);
            if (fullProduct) {
              Object.assign(product, fullProduct);
            }
          } else if (typeof window.homeProducts !== 'undefined' && window.homeProducts.length > 0) {
            const fullProduct = window.homeProducts.find(p => p.id === product.id);
            if (fullProduct) {
              Object.assign(product, fullProduct);
            }
          }
          
          showQuickViewModal(product);
        } catch (error) {
          // Error parsing product data
        }
      });

      // Close modal handlers (if not already handled by custom.js)
      $(document).on('click', '.product-quick-view-modal .btn-close, .canvas-overlay', function() {
        $('.product-quick-view-modal').removeClass('active');
        
        // Remove fix class from both html and body
        $('html, body').removeClass('fix');
        
        // Restore scroll position
        const scrollPosition = $('html').data('scroll-position') || $('body').data('scroll-position') || 0;
        
        // Use requestAnimationFrame to ensure DOM updates before scrolling
        requestAnimationFrame(function() {
          window.scrollTo(0, scrollPosition);
          $('html, body').removeData('scroll-position');
        });
      });
      
      // Handle quantity buttons in modal (event delegation for dynamically created elements)
      $(document).on('click', '.product-quick-view-modal .qty-btn', function(e) {
        e.preventDefault();
        const $button = $(this);
        const $input = $button.parent().find('input');
        const oldValue = parseInt($input.val()) || 1;
        const maxStock = parseInt($input.attr('data-max-stock')) || 9999;
        
        if ($button.hasClass('inc')) {
          const newVal = oldValue + 1;
          if (newVal <= maxStock) {
            $input.val(newVal);
          } else {
            showToast(`Maximum available quantity is ${maxStock}`, 'warning');
          }
        } else if ($button.hasClass('dec')) {
          if (oldValue > 1) {
            const newVal = oldValue - 1;
            $input.val(newVal);
          } else {
            $input.val(1);
          }
        }
      });
      
      // Handle direct input change for quantity (both change and input events)
      $(document).on('change input', '.product-quick-view-modal #modal-quantity', function(e) {
        const $input = $(this);
        const maxStock = parseInt($input.attr('data-max-stock')) || parseInt($input.attr('max')) || 9999;
        let value = parseInt($input.val()) || 1;
        
        if (value < 1) {
          value = 1;
          $input.val(value);
        } else if (value > maxStock) {
          value = maxStock;
          $input.val(value);
          if (e.type === 'change') {
            showToast(`Maximum available quantity is ${maxStock}`, 'warning');
          }
        }
      });
      
      // Also handle blur to ensure final value is valid
      $(document).on('blur', '.product-quick-view-modal #modal-quantity', function() {
        const $input = $(this);
        const maxStock = parseInt($input.attr('data-max-stock')) || parseInt($input.attr('max')) || 9999;
        let value = parseInt($input.val()) || 1;
        
        if (value < 1) value = 1;
        if (value > maxStock) {
          value = maxStock;
          showToast(`Maximum available quantity is ${maxStock}`, 'warning');
        }
        $input.val(value);
      });
      
      // Handle keyup to validate while typing
      $(document).on('keyup', '.product-quick-view-modal #modal-quantity', function(e) {
        const $input = $(this);
        const maxStock = parseInt($input.attr('data-max-stock')) || parseInt($input.attr('max')) || 9999;
        let value = parseInt($input.val());
        
        // Only validate if it's a number
        if (!isNaN(value) && value > maxStock) {
          $input.val(maxStock);
          showToast(`Maximum available quantity is ${maxStock}`, 'warning');
        }
      });
    }
    
  })(jQuery);
  </script>

</body>

</html>
