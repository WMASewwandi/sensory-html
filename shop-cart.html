<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/">

    <title>Shop Cart - Sensory - Kids Toys Store</title>

    <!--== Favicon ==-->
    <link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon" />

    <!--== Google Fonts ==-->
    <link href="https://fonts.googleapis.com/css?family=Fredoka+One:400" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!--== Bootstrap CSS ==-->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet"/>
    <!--== Font-awesome Icons CSS ==-->
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet"/>
    <!--== Pe Icon 7 Min Icons CSS ==-->
    <link href="/assets/css/pe-icon-7-stroke.min.css" rel="stylesheet"/>
    <!--== Ionicons CSS ==-->
    <link href="/assets/css/ionicons.css" rel="stylesheet"/>
    <!--== Animate CSS ==-->
    <link href="/assets/css/animate.css" rel="stylesheet"/>
    <!--== Aos CSS ==-->
    <link href="/assets/css/aos.css" rel="stylesheet"/>
    <!--== FancyBox CSS ==-->
    <link href="/assets/css/jquery.fancybox.min.css" rel="stylesheet"/>
    <!--== Slicknav CSS ==-->
    <link href="/assets/css/slicknav.css" rel="stylesheet"/>
    <!--== Swiper CSS ==-->
    <link href="/assets/css/swiper.min.css" rel="stylesheet"/>
    <!--== Slick CSS ==-->
    <link href="/assets/css/slick.css" rel="stylesheet"/>
    <!--== Rangeslider CSS ==-->
    <link href="/assets/css/rangeslider.css" rel="stylesheet"/>
    <!--== Main Style CSS ==-->
    <link href="/assets/css/style.css" rel="stylesheet" />

</head>

<body>

<!--wrapper start-->
<div class="wrapper page-shop-wrapper">

  <!--== Start Preloader Content ==-->
  <div class="preloader-wrap">
    <div class="preloader">
      <span class="dot"></span>
      <div class="dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
  <!--== End Preloader Content ==-->

  <!--== Start Header Wrapper ==-->
  <header class="header-wrapper">
    <div class="header-top">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-sm-5 col-md-4 col-lg-6">
            <div class="header-info-left">
            </div>
          </div>
          <div class="col-xs-12 col-sm-7 col-md-8 col-lg-6 sm-pl-0 xs-pl-15 header-top-right">
            <div class="header-info">
              <a href="tel://+94761487787"><i class="fa fa-phone"></i> +94761487787</a>
              <a href="mailto:sensorysl12@gmail.com"><i class="fa fa-envelope"></i> sensorysl12@gmail.com</a>
              <a href="login-register"><i class="fa fa-user"></i> Account</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-middle">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-12">
            <div class="header-align">
              <div class="header-align-left">
                <div class="header-logo-area">
                  <a href="/">
                    <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                    <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
                  </a>
                </div>
              </div>
              <div class="header-align-center">
                <div class="header-search-box">
                  <form action="#" method="post">
                    <div class="form-input-item">
                      <label for="search" class="sr-only">Search Everything</label>
                      <input type="text" id="search" placeholder="Search Everything">
                      <button type="submit" class="btn-src">
                        <i class="pe-7s-search"></i>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
              <div class="header-align-right">
                <div class="header-action-area">
                  <div class="header-action-wishlist">
                    <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                      <span class="wishlist-count">0</span>
                      <i class="pe-7s-like"></i>
                    </button>
                  </div>
                  <div class="header-action-cart">
                    <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                      <span class="cart-count">0</span>
                      <i class="pe-7s-shopbag"></i>
                    </button>
                  </div>
                  <button class="btn-menu d-md-none">
                    <i class="ion-navicon"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="header-area header-default sticky-header">
      <div class="container">
        <div class="row row-gutter-0 align-items-center">
          <div class="col-4 col-sm-6 col-lg-2">
            <div class="header-logo-area">
              <a href="/">
                <img class="logo-main" src="/assets/img/logo.png" alt="Logo" />
                <img class="logo-light" src="/assets/img/logo.png" alt="Logo" />
              </a>
            </div>
          </div>
          <div class="col-lg-8 sticky-md-none">
            <div class="header-nav-scroll-wrap">
              <button type="button" class="nav-scroll-btn nav-scroll-left" aria-label="Scroll menu left">
                <i class="fa fa-angle-left"></i>
              </button>
              <div class="header-navigation-area d-none d-md-block">
                <ul class="main-menu nav position-relative" id="main-nav-menu">
                  <li><a class="ml--2" href="/">Home</a></li>
                  <!-- Main category links are injected by JS (up to 5 categories) -->
                </ul>
              </div>
              <button type="button" class="nav-scroll-btn nav-scroll-right" aria-label="Scroll menu right">
                <i class="fa fa-angle-right"></i>
              </button>
            </div>
          </div>
          <div class="col-8 col-sm-6 col-lg-2">
            <div class="header-action-area">
              <div class="header-action-search">
                <button class="btn-search btn-search-menu">
                  <i class="pe-7s-search"></i>
                </button>
              </div>
              <div class="header-action-login">
                <button class="btn-login" onclick="window.location.href='login-register'">
                  <i class="pe-7s-users"></i>
                </button>
              </div>
              <div class="header-action-wishlist">
                <button class="btn-wishlist" onclick="window.location.href='shop-wishlist'">
                  <i class="pe-7s-like"></i>
                </button>
              </div>
              <div class="header-action-cart">
                <button class="btn-cart cart-icon" onclick="window.location.href='shop-cart'">
                  <span class="cart-count">0</span>
                  <i class="pe-7s-shopbag"></i>
                </button>
              </div>
              <button class="btn-menu d-lg-none">
                <i class="ion-navicon"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <!--== End Header Wrapper ==-->
  
  <main class="main-content">
    <!--== Start Page Title Area ==-->
    <section class="page-title-area">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-12 m-auto">
            <div class="page-title-content text-center">
              <h2 class="title">Cart</h2>
              <!-- <div class="bread-crumbs"><a href="/"> Home </a><span class="breadcrumb-sep"> // </span><span class="active"> Cart</span></div> -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--== End Page Title Area ==-->

    <!--== Start Cart Area Wrapper ==-->
    <section class="product-area cart-page-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 m-auto">
            <div class="section-title text-center">
              <h2 class="title">Cart</h2>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="cart-table-wrap">
              <div class="cart-table table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th class="width-thumbnail"></th>
                      <th class="width-name">Product</th>
                      <th class="width-price"> Price</th>
                      <th class="width-quantity">Quantity</th>
                      <th class="width-subtotal">Subtotal</th>
                      <th class="width-remove"></th>
                    </tr>
                  </thead>
                  <tbody id="cart-items-container">
                    <!-- Cart items will be loaded dynamically here -->
                  </tbody>
              </table>
              </div>
            </div>
            <div class="cart-shiping-update-wrapper">
              <div class="cart-shiping-btn continure-btn">
                <a class="btn btn-link" href="shop"><i class="ion-ios-arrow-left"></i> Back To Shop</a>
              </div>
              <div class="cart-shiping-btn update-btn">
                <div class="grand-total-wrap">
                  <div class="grand-total-content">
                    <div class="grand-total">
                      <h4>Total <span id="cart-total">LKR 0.00</span></h4>
                    </div>
                  </div>
                  <div class="grand-total-btn">
                    <a class="btn btn-link" href="shop-checkout">Proceed to checkout</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--== End Cart Area Wrapper ==-->
  </main>

  <!--== Start Footer Area Wrapper ==-->
  <footer class="footer-area default-style" >
    <div class="footer-main">
      <div class="container">
        <div class="row">
          <div class="col-12 col-lg-4">
            <div class="widget-item item-style3">
              <div class="about-widget">
                <a class="footer-logo" href="/">
                  <img src="/assets/img/logo-light.png" alt="Logo">
                </a>
                <p>
                  Sensory a brand of ANKH Trading Pvt Ltd is a curated destination for premium sensory books, toddler sensory, and early learning products, created to support holistic childhood development. We bring together safe, reliable, and thoughtfully designed sensory essentials in one placeâ€”making it easier for parents, educators, and retailers to access quality products that encourage learning through play, exploration, and imagination.
0 
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-2">
            <div class="widget-item item-style1">
              <h4 class="widget-title">Quick Links</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-1">Quick Links</h4>
              <div id="dividerId-1" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap">
                  <ul class="nav-menu nav item-hover-style">
                    <li><a href="/">- Home</a></li>
                    <li><a href="about">- About</a></li>
                    <li><a href="shop">- Shop</a></li>
                    <li><a href="contact">- Contact</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="widget-item item-style2">
              <h4 class="widget-title">Company</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-3">Company</h4>
              <div id="dividerId-3" class="collapse widget-collapse-body">
                <nav class="widget-menu-wrap item-hover-style">
                  <ul class="nav-menu nav">
                    <li><a href="terms-and-conditions">- Terms & Conditions</a></li>
                    <li><a href="privacy-policy">- Privacy Policy</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="widget-item">
              <h4 class="widget-title">Store Information.</h4>
              <h4 class="widget-title widget-collapsed-title collapsed" data-bs-toggle="collapse" data-bs-target="#dividerId-4">Store Information.</h4>
              <div id="dividerId-4" class="collapse widget-collapse-body">
                <p class="widget-address">296/A/1 , Level 2 <br>New Kandy Road, <br>Kothalawala, <br>Kaduwela,
                    <br>Sri Lanka</p>
                  <ul class="widget-contact-info">
                    <li>Phone: <a href="tel://+94761487787">+94761487787</a></li>
                    <li>Email: <a href="mailto:sensorysl12@gmail.com">sensorysl12@gmail.com</a></li>
                  </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <div class="footer-bottom-content">
          <div class="row text-center">
            <div class="col-sm-12">
              <div class="widget-copyright">
                <p><i class="fa fa-copyright"></i> 2025 <span>Sensory. </span> All Rights Reserved</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-shape bg-img" data-bg-img="/assets/img/photos/footer1.png"></div>
  </footer>
  <!--== End Footer Area Wrapper ==-->
  
  <!--== Scroll Top Button ==-->
  <div class="scroll-to-top"><span class="fa fa-angle-double-up"></span></div>

  <!--== Start Product Quick View ==-->
  <aside class="product-quick-view-modal">
    <div class="product-quick-view-inner">
      <button type="button" class="btn-close product-quick-view-close">
        <span class="pe-7s-close"><i class="lastudioicon-e-remove"></i></span>
      </button>
      <div class="product-quick-view-content">
        <div class="row row-gutter-0">
          <div class="col-lg-6 col-md-6 col-12">
            <div class="thumb">
              <img src="/assets/img/shop/quick-view1.jpg" alt="Image">
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-12">
            <div class="single-product-info">
              <h4 class="title">Your Products Name Here.</h4>
              <div class="prices">
                <span class="price">LKR 0.00</span>
              </div>
              <div class="product-rating">
                <div class="rating">
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                  <span class="fa fa-star"></span>
                </div>
                <div class="review">
                  <a href="#/">( 5 Customer Review )</a>
                </div>
              </div>
              <p class="product-desc">Lorem ipsum dolor sit amet, consect adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quisll exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duisol aute irure dolor in reprehenderit.</p>
              <div class="quick-product-action">
                <div class="action-top">
                  <div class="pro-qty">
                    <input type="text" id="quantity" title="Quantity" value="01" />
                  </div>
                  <button class="btn btn-theme">Add to Cart</button>
                  <a class="btn-wishlist" href="shop-wishlist">Add to Wishlist</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">SKU:</h3>
                <div class="widget-tags">
                  <span>Ch-256xl</span>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Categories:</h3>
                <div class="widget-tags">
                  <a href="blog">Toys.</a>
                  <a href="blog">Dresss</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Tag:</h3>
                <div class="widget-tags">
                  <a href="blog">Toys,</a>
                  <a href="blog">Dress</a>
                </div>
              </div>
              <div class="widget">
                <h3 class="title">Share:</h3>
                <div class="widget-tags widget-share">
                  <span class="fa fa-facebook"></span>
                  <span class="fa fa-dribbble"></span>
                  <span class="fa fa-pinterest-p"></span>
                  <span class="fa fa-twitter"></span>
                  <span class="fa fa-linkedin"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="canvas-overlay"></div>
  </aside>
  <!--== End Product Quick View ==-->

  <!--== Start Aside Search Menu ==-->
  <div class="search-box-wrapper">
    <div class="search-box-content-inner">
      <div class="search-box-form-wrap">
        <div class="search-note">
          <p>Start typing and press Enter to search</p>
        </div>
        <form action="#" method="post">
          <div class="search-form position-relative">
            <label for="search-input" class="sr-only">Search</label>
            <input type="search" class="form-control" placeholder="Search" id="search-input">
            <button class="search-button"><i class="pe-7s-search"></i></button>
          </div>
        </form>
      </div>
    </div>
    <!--== End Aside Search Menu ==-->
    <a href="javascript:;" class="search-close"><i class="pe-7s-close"></i></a>
  </div>
  <!--== End Aside Search Menu ==-->

  <!--== Start Sidebar Cart Menu ==-->
  <aside class="sidebar-cart-modal">
    <div class="sidebar-cart-inner">
      <div class="sidebar-cart-content">
        <a class="cart-close" href="javascript:void(0);"><i class="pe-7s-close"></i></a>
        <div class="sidebar-cart-all">
          <div class="cart-header">
            <h3>Shopping Cart</h3>
            <div class="close-style-wrap">
              <span class="close-style close-style-width-1 cart-close"></span>
            </div>
          </div>
          <div class="cart-content cart-content-padding">
            <ul id="sidebar-cart-items">
              <!-- Cart items will be loaded dynamically here -->
            </ul>
            <div class="cart-total">
              <h4>Subtotal: <span id="sidebar-cart-subtotal">LKR 0.00</span></h4>
            </div>
            <div class="cart-checkout-btn">
              <a class="cart-btn" href="shop-cart">view cart</a>
              <a class="checkout-btn" href="shop-checkout">checkout</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-cart-overlay"></div>
  <!--== End Sidebar Cart Menu ==-->

  <!--== Start Side Menu ==-->
  <aside class="off-canvas-wrapper">
    <div class="off-canvas-inner">
      <div class="off-canvas-overlay d-none"></div>
      <!-- Start Off Canvas Content Wrapper -->
      <div class="off-canvas-content">
        <!-- Off Canvas Header -->
        <div class="off-canvas-header">
          <div class="close-action">
            <button class="btn-close"><i class="pe-7s-close"></i></button>
          </div>
        </div>

        <div class="off-canvas-item">
          <!-- Start Mobile Menu Wrapper -->
          <div class="res-mobile-menu">
            <!-- Note Content Auto Generate By Jquery From Main Menu -->
          </div>
          <!-- End Mobile Menu Wrapper -->
        </div>
        <!-- Off Canvas Footer -->
        <div class="off-canvas-footer"></div>
      </div>
      <!-- End Off Canvas Content Wrapper -->
    </div>
  </aside>
  <!--== End Side Menu ==-->
</div>

<!--=======================Javascript============================-->

<!--=== Modernizr Min Js ===-->
<script src="/assets/js/modernizr.js"></script>
<!--=== jQuery Min Js ===-->
<script src="/assets/js/jquery-main.js"></script>
<!--=== jQuery Migration Min Js ===-->
<script src="/assets/js/jquery-migrate.js"></script>
<!--=== Popper Min Js ===-->
<script src="/assets/js/popper.min.js"></script>
<!--=== Bootstrap Min Js ===-->
<script src="/assets/js/bootstrap.min.js"></script>
<!--=== jquery Appear Js ===-->
<script src="/assets/js/jquery.appear.js"></script>
<!--=== jquery Swiper Min Js ===-->
<script src="/assets/js/swiper.min.js"></script>
<!--=== jquery Fancybox Min Js ===-->
<script src="/assets/js/fancybox.min.js"></script>
<!--=== jquery Aos Min Js ===-->
<script src="/assets/js/aos.min.js"></script>
<!--=== jquery Slicknav Js ===-->
<script src="/assets/js/jquery.slicknav.js"></script>
<!--=== jquery Countdown Js ===-->
<script src="/assets/js/jquery.countdown.min.js"></script>
<!--=== jquery Tippy Js ===-->
<script src="/assets/js/tippy.all.min.js"></script>
<!--=== Isotope Min Js ===-->
<script src="/assets/js/isotope.pkgd.min.js"></script>
<!--=== Parallax Min Js ===-->
<script src="/assets/js/parallax.min.js"></script>
<!--=== Slick  Min Js ===-->
<script src="/assets/js/slick.min.js"></script>
<!--=== jquery Wow Min Js ===-->
<script src="/assets/js/wow.min.js"></script>
<!--=== jquery Zoom Min Js ===-->
<script src="/assets/js/jquery-zoom.min.js"></script>

<!--=== API Config Js ===-->
<script src="/assets/js/config.js"></script>
<!--=== Cart & Wishlist Service Js ===-->
<script src="/assets/js/cart-service.js"></script>
<!--=== API Service Js ===-->
<script src="/assets/js/api-service.js"></script>
<!--=== Custom Js ===-->
<script src="/assets/js/custom.js"></script>
<!--=== Cart Page Js ===-->
<script>
(function($) {
  'use strict';
  
  // Debug: Check localStorage directly
  function checkLocalStorageCart() {
    const user = window.getCurrentUser ? window.getCurrentUser() : null;
    let cartKey = 'cart_guest';
    if (user && user.id) {
      cartKey = `cart_${user.id}`;
    }
    
    const storedCart = localStorage.getItem(cartKey);
    console.log('Cart key:', cartKey);
    console.log('Stored cart data:', storedCart);
    
    if (storedCart) {
      try {
        const parsed = JSON.parse(storedCart);
        console.log('Parsed cart:', parsed);
      } catch (e) {
        console.error('Error parsing cart:', e);
      }
    } else {
      console.log('No cart found in localStorage with key:', cartKey);
      // Try all cart keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('cart_')) {
          console.log('Found cart key:', key, 'Value:', localStorage.getItem(key));
        }
      }
    }
  }
  
  // Format price with LKR currency
  function formatPrice(price) {
    if (price === null || price === undefined || price === 0) {
      return 'LKR 0.00';
    }
    return 'LKR ' + parseFloat(price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  
  // Toast notification function
  function showToast(message, type = 'success') {
    // Remove existing toasts
    $('.toast-notification').remove();
    
    const icon = type === 'success' ? '<i class="ion-checkmark-circled"></i>' : 
                 type === 'error' ? '<i class="ion-close-circled"></i>' : 
                 '<i class="ion-information-circled"></i>';
    const toast = $(`
      <div class="toast-notification ${type}" style="position:fixed;top:20px;right:20px;padding:15px 20px;color:#fff;border-radius:4px;z-index:9999;display:flex;align-items:center;gap:12px;min-width:300px;font-size:14px;background-color:${type === 'success' ? '#4CAF50' : type === 'error' ? '#dc3545' : '#ffc107'};${type === 'warning' ? 'color:#000;' : ''}">
        <span class="toast-icon" style="font-size:20px;">${icon}</span>
        <span class="toast-message" style="flex:1;">${message}</span>
        <span class="toast-close" style="cursor:pointer;font-size:18px;opacity:0.8;">&times;</span>
      </div>
    `);
    
    $('body').append(toast);
    
    // Auto hide after 3 seconds
    setTimeout(function() {
      toast.fadeOut(300, function() { $(this).remove(); });
    }, 3000);
    
    // Close on click
    toast.find('.toast-close').on('click', function() {
      toast.fadeOut(300, function() { $(this).remove(); });
    });
  }
  
  // Get cart directly from localStorage as fallback
  function getCartDirectly() {
    try {
      // Try to get user from multiple possible locations
      let user = null;
      
      // Method 1: window.getCurrentUser()
      if (typeof window.getCurrentUser === 'function') {
        user = window.getCurrentUser();
      }
      
      // Method 2: Direct localStorage access
      if (!user) {
        try {
          const loggedInUserStr = localStorage.getItem('loggedInUser');
          if (loggedInUserStr) {
            user = JSON.parse(loggedInUserStr);
          }
        } catch (e) {
          console.warn('Error parsing loggedInUser from localStorage:', e);
        }
      }
      
      console.log('Current user:', user);
      
      // Determine cart key
      let cartKey = 'cart_guest';
      if (user && user.id) {
        cartKey = `cart_${user.id}`;
      }
      
      console.log('Looking for cart with key:', cartKey);
      
      // Try the expected cart key first
      const storedCart = localStorage.getItem(cartKey);
      if (storedCart) {
        console.log('Found cart with expected key:', cartKey);
        const parsed = JSON.parse(storedCart);
        return Array.isArray(parsed) ? parsed : [];
      }
      
      // Try to find any cart key (fallback)
      console.log('Cart not found with expected key, searching all cart keys...');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('cart_')) {
          const cartData = localStorage.getItem(key);
          if (cartData) {
            try {
              const parsed = JSON.parse(cartData);
              if (Array.isArray(parsed) && parsed.length > 0) {
                console.log('Found cart in key:', key, 'Items:', parsed);
                return parsed;
              }
            } catch (e) {
              console.error('Error parsing cart from key', key, ':', e);
            }
          }
        }
      }
      
      console.log('No cart found in localStorage');
      return [];
    } catch (error) {
      console.error('Error getting cart directly:', error);
      return [];
    }
  }
  
  // Render cart items
  async function renderCart() {
    try {
      let cart = [];
      
      // Try to get cart from CartService first
      if (typeof CartService !== 'undefined' && typeof CartService.getCart === 'function') {
        cart = CartService.getCart();
        console.log('Got cart from CartService:', cart);
      } else {
        // Fallback: get cart directly from localStorage
        console.warn('CartService not available, using direct localStorage access');
        cart = getCartDirectly();
      }
      
      // Fetch stock levels
      let stockMap = new Map();
      try {
        if (typeof window.getStockMap === 'function') {
          stockMap = await window.getStockMap();
        }
      } catch (stockError) {
        console.warn('Failed to fetch stock levels:', stockError);
      }
      
      const container = $('#cart-items-container');
      const subtotalEl = $('#cart-subtotal');
      const totalEl = $('#cart-total');
      
      // Debug logging
      console.log('Cart items:', cart);
      console.log('Container found:', container.length);
      
      if (!container.length) {
        console.error('Cart container not found: #cart-items-container');
        // Try to find it with a different selector
        const altContainer = $('tbody#cart-items-container, #cart-items-container');
        if (altContainer.length) {
          console.log('Found container with alternative selector');
        }
        return;
      }
      
      if (!cart || !Array.isArray(cart) || cart.length === 0) {
        container.html('<tr><td colspan="7" class="text-center">Your cart is empty. <a href="shop">Continue Shopping</a></td></tr>');
        if (subtotalEl.length) subtotalEl.text('LKR 0.00');
        if (totalEl.length) totalEl.text('LKR 0.00');
        return;
      }
      
      container.empty();
      let subtotal = 0;
      let hasStockIssues = false;
      
      cart.forEach((item) => {
        if (!item || !item.id) {
          console.warn('Invalid cart item:', item);
          return;
        }
        
        // Handle price: even if 0, still display the item
        const itemPrice = parseFloat(item.price) || 0;
        const itemQuantity = parseInt(item.quantity) || 1;
        const itemTotal = itemPrice * itemQuantity;
        subtotal += itemTotal;
        
        const imageUrl = item.imageURL || item.imageUrl || 'https://www.holoimage.net/images/no-image.jpg';
        const productName = item.name || 'Product';
        
        // Get stock level for this item
        const availableStock = stockMap.get(item.id) || item.maxStock || 9999;
        const isOutOfStock = availableStock <= 0;
        const isOverStock = itemQuantity > availableStock;
        
        if (isOutOfStock || isOverStock) {
          hasStockIssues = true;
        }
        
        // Stock status indicator
        let stockStatusHtml = '';
        if (isOutOfStock) {
          stockStatusHtml = '<span class="text-danger"><small>Out of Stock</small></span>';
        } else if (isOverStock) {
          stockStatusHtml = `<span class="text-warning"><small>Only ${availableStock} available</small></span>`;
        } else if (availableStock <= 5) {
          stockStatusHtml = `<span class="text-warning"><small>Only ${availableStock} left</small></span>`;
        } else {
          stockStatusHtml = `<span class="text-success"><small>In Stock (${availableStock})</small></span>`;
        }
        
        console.log('Rendering cart item:', {
          id: item.id,
          name: productName,
          price: itemPrice,
          quantity: itemQuantity,
          total: itemTotal,
          availableStock: availableStock
        });
        
        const rowHtml = `
          <tr data-product-id="${item.id}" class="${isOutOfStock || isOverStock ? 'table-warning' : ''}">
            <td class="product-thumbnail">
              <a  href="javascript:void(0)"><img src="${imageUrl}" alt="${productName}" onerror="this.src='https://www.holoimage.net/images/no-image.jpg'"></a>
            </td>
            <td class="product-name">
              <h5><a href="shop-single-product.html?id=${item.id}">${productName}</a></h5>
              ${stockStatusHtml}
            </td>
            <td class="product-price"><span class="amount">${formatPrice(itemPrice)}</span></td>
            <td class="cart-quality">
              <div class="product-details-quality">
                <input type="number" class="input-text qty text cart-qty-input" step="1" min="1" max="${availableStock}" name="quantity" value="${itemQuantity}" title="Qty" data-product-id="${item.id}" ${isOutOfStock ? 'disabled' : ''}>
              </div>
            </td>
            <td class="product-total"><span class="item-total">${formatPrice(itemTotal)}</span></td>
            <td class="product-remove"><a href="javascript:void(0)" class="remove-cart-item" data-product-id="${item.id}"><i class="ion-ios-trash-outline"></i></a></td>
          </tr>
        `;
        
        container.append(rowHtml);
      });
      
      if (subtotalEl.length) subtotalEl.text(formatPrice(subtotal));
      if (totalEl.length) totalEl.text(formatPrice(subtotal));
      
      // Show warning if there are stock issues
      if (hasStockIssues) {
        const warningHtml = '<div class="alert alert-warning mt-3" id="stock-warning"><strong>Warning:</strong> Some items in your cart have stock issues. Please adjust quantities or remove unavailable items before checkout.</div>';
        if (!$('#stock-warning').length) {
          container.closest('table').after(warningHtml);
        }
      } else {
        $('#stock-warning').remove();
      }
      
      console.log('Cart rendered successfully. Items:', cart.length, 'Subtotal:', subtotal);
    } catch (error) {
      console.error('Error rendering cart:', error);
      console.error('Error stack:', error.stack);
    }
  }
  
  // Handle quantity change with stock validation
  $(document).on('change', '.cart-qty-input', async function() {
    const $input = $(this);
    const productId = $input.data('product-id');
    let quantity = parseInt($input.val()) || 1;
    
    // Validate against max stock
    const maxStock = parseInt($input.attr('max')) || 9999;
    if (quantity > maxStock) {
      quantity = maxStock;
      $input.val(quantity);
      showToast(`Maximum available quantity is ${maxStock}`, 'warning');
    }
    
    if (quantity < 1) {
      quantity = 1;
      $input.val(quantity);
    }
    
    // Use stock-validated update if available
    if (typeof CartService.updateQuantityWithStockCheck === 'function') {
      const result = await CartService.updateQuantityWithStockCheck(productId, quantity);
      if (!result.success) {
        showToast(result.message || 'Failed to update quantity', 'error');
        // Revert to previous value if failed
        const cart = CartService.getCart();
        const item = cart.find(i => i.id === productId);
        if (item) {
          $input.val(item.quantity);
        }
      }
    } else {
      CartService.updateQuantity(productId, quantity);
    }
    
    renderCart();
    CartService.updateCartCount();
    
    // Also update sidebar cart if function exists
    if (typeof loadSidebarCart === 'function') {
      loadSidebarCart();
    }
  });
  
  // Handle remove item
  $(document).on('click', '.remove-cart-item', function() {
    const productId = $(this).data('product-id');
    CartService.removeFromCart(productId);
    renderCart();
    CartService.updateCartCount();
    
    // Also update sidebar cart if function exists
    if (typeof loadSidebarCart === 'function') {
      loadSidebarCart();
    }
  });
  
  // Listen for cart updates from sidebar
  $(document).on('cartUpdated', function() {
    renderCart();
    CartService.updateCartCount();
  });
  
  // Initialize cart on page load
  $(document).ready(function() {
    // Check localStorage directly for debugging
    checkLocalStorageCart();
    
    // Wait a bit to ensure all scripts are loaded
    setTimeout(function() {
      // Check if CartService is available
      if (typeof CartService === 'undefined') {
        console.error('CartService is not defined. Make sure cart-service.js is loaded.');
        console.log('Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('cart')));
        
        // Try to access via window
        if (typeof window.CartService !== 'undefined') {
          console.log('Found CartService on window object');
        }
        
        // Retry after a longer delay
        setTimeout(function() {
          if (typeof CartService !== 'undefined' || typeof window.CartService !== 'undefined') {
            const service = CartService || window.CartService;
            console.log('CartService now available, rendering cart...');
            renderCart();
            if (service.updateCartCount) {
              service.updateCartCount();
            }
          }
        }, 500);
        return;
      }
      
      console.log('Initializing cart page...');
      console.log('CartService available:', typeof CartService);
      
      // Render cart
      renderCart();
      
      // Update cart count
      if (typeof CartService.updateCartCount === 'function') {
        CartService.updateCartCount();
      }
      
      // Also load sidebar cart if function exists
      if (typeof loadSidebarCart === 'function') {
        loadSidebarCart();
      }
    }, 100);
    
    // Also try on window load as fallback
    $(window).on('load', function() {
      console.log('Window loaded, checking cart again...');
      if (typeof CartService !== 'undefined' || typeof window.CartService !== 'undefined') {
        const service = CartService || window.CartService;
        renderCart();
        if (service && service.updateCartCount) {
          service.updateCartCount();
        }
      }
    });
  });
  
})(jQuery);
</script>

</body>

</html>